<div ng-controller="BillableCtrl">
    <div class="section-group-title">
        <span ng-class="{'error-message-underline': validationStarted && nestedFormAccommodation.$invalid}">
            {{ 'Select your accommodation' | i18n }}:
        </span>
        <span ng-if="field.isRequired" class="regFormMandatoryField">*</span>
    </div>
    <ng-form name="nestedFormAccommodation">
        <table cellspacing="0">
            <tr ng-if="field.choices.length === 0">
                <td class="section-placeholder">
                    {{ 'There are no available accommodation options' | i18n }}.
                </td>
            </tr>
            <tr ngif="!field.isRequired">
                <td class="accommodation-option-item">
                    <input type="radio" name="accommodationType-{{ field.id }}"
                           ng-model="accommodation.choice"
                           ng-checked="!userdata[fieldName].choice"
                           nd-radio-extend/>
                    {{ 'No accommodation' | i18n }}
                </td>
            </tr>
            <tr ng-repeat="item in field.choices">
                <td align="left" class="accommodation-option-item">
                    <input type="radio" nd-radio-extend
                        id="{{ item.id }}"
                        name="accommodationType-{{ field.id }}"
                        value="{{ item.id }}"
                        ng-checked="userdata[fieldName].choice == item.id"
                        ng-model="accommodation.choice"
                        ng-disabled="isDisabled(item, userdata.accommodation.choice) || !userdata.manager && (paymentBlocked(item, userdata) || billableOptionPayed(userdata))"
                        ng-required="field.isRequired"/>
                    {{ item.caption }}

                    <span class="unavailable-text" ng-if="item.cancelled && !hasPlacesLeft(item, userdata.accommodation.choice)">
                        ({{ 'currently not available' | i18n }})
                    </span>
                    <span ng-if="hasPlacesLimit(item)">
                        <span class="unavailable-text" ng-if="!item.cancelled && !hasPlacesLeft(item, userdata.accommodation.choice)">
                            ({{ 'no places left' | i18n }})
                        </span>
                        <span class="available-text" ng-if="!item.cancelled && hasPlacesLeft(item, userdata.accommodation.choice)">
                            [{{ getPlacesLeft(item, userdata.accommodation.choice, accommodation.choice) }} {{ "place(s) left" | i18n }}]
                        </span>
                    </span>
                </td>
                <td align="right">
                    <span ng-if="item.id == accommodation.choice && userdata.accommodation.billable">
                        <span class="regFormPrice">{{ userdata.accommodation.price }}</span>
                        <nd-currency currency="currency"></nd-currency>
                        <span ng-if="item.isBillable">{{ "per night" | i18n }}</span>
                    </span>

                    <span ng-if="item.id != accommodation.choice && item.isBillable">
                        <span class="regFormPrice">{{ item.price }}</span>
                        <nd-currency currency="currency"></nd-currency>
                        <span ng-if="item.isBillable">{{ "per night" | i18n }}</span>
                    </span>
                </td>
                <td>
                    <span ng-if="!userdata.manager && (paymentBlocked(item, userdata) || billableOptionPayed(userdata))"
                          class="icon-warning billable-items-warning"
                          data-qtip-style="error"
                          title="{{ 'This option could trigger a price change and has been blocked.' | i18n }}">
                    </span>
                </td>
                <td>
                    <span ng-if="field.deletedChoice && field.deletedChoice.indexOf(item.id) != -1"
                          class="icon-warning deleted-option-warning right"
                          data-qtip-style="error"
                          title="{{ 'The currently chosen option is not available anymore. If you unselect it you won\'t be able to choose it back' | i18n }}">
                    </span>
                </td>
            </tr>
        </table>
        <input type="hidden" name="{{ field.htmlName }}" value="{{ userdata[fieldName] }}">
    </ng-form>
    <table cellspacing="0">
        <tr>
            <td align="left">
                <span>{{ 'Arrival date' | i18n }}</span>
                <span ng-if="field.isRequired" class="regFormMandatoryField">*</span>
            </td>
            <td align="left">
                <ng-form name="nestedFormArrival">
                    <select required
                        id="arrivalDate"
                        ng-model="accommodation.arrivalDate"
                        ng-class="{hasError: validationStarted && nestedFormArrival.$invalid}"
                        ng-disabled="(!userdata.manager && billableOptionPayed(userdata)) || !accommodation.choice"
                        ng-required="field.isRequired || accommodation.choice">
                        <option value="" selected>{{ 'Select a date' | i18n }}</option>
                        <option ng-repeat="date in field.arrivalDates" value="{{ date[0] }}"
                                ng-selected="userdata[fieldName].arrivalDate == date[0]">
                            {{ date[1] }}
                        </option>
                    </select>
                </ng-form>
            </td>
        </tr>
        <tr>
            <td align="left">
                <span>{{ 'Departure date' | i18n }}</span>
                <span ng-if="field.isRequired" class="regFormMandatoryField">*</span>
            </td>
            <td align="left">
                <ng-form name="nestedFormDeparture">
                    <select required
                        id="departureDate"
                        ng-model="accommodation.departureDate"
                        ng-class="{hasError: validationStarted && nestedFormDeparture.$invalid}"
                        ng-disabled="(!userdata.manager && billableOptionPayed(userdata)) || !accommodation.choice"
                        ng-required="field.isRequired || accommodation.choice">
                        <option value="" selected>{{ 'Select a date' | i18n }}</option>
                        <option ng-repeat="date in field.departureDates" value="{{ date[0] }}"
                                ng-selected="userdata[fieldName].departureDate == date[0]">
                            {{ date[1] }}
                        </option>
                    </select>
                </ng-form>
            </td>
        </tr>
    </table>
</div>
