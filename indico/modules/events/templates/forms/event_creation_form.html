{% from 'forms/_form.html' import form_header, form_footer, form_rows, form_row, form_fieldset %}
{% set category = {'id': form.category.data.id,
                   'is_protected': form.category.data.is_protected,
                   'title': form.category.data.title} if form.category.data else none %}

{{ form_header(form, action=url_for('events.create', event_type=event_type)) }}
{{ form_row(form.category, orientation=('hidden' if single_category else '')) }}
{{ form_rows(form, fields=form._field_order) }}
{% if form._advanced_field_order %}
    {% call form_fieldset(_('Advanced'), collapsible=true) %}
        {{ form_rows(form, fields=form._advanced_field_order) }}
    {% endcall %}
{% endif %}
{% call form_footer(form) %}
    <input class="i-button big highlight" type="submit" value="{% trans %}Create event{% endtrans %}"
           data-disabled-until-change>
    <button type="button" class="i-button big" data-button-back>{% trans %}Cancel{% endtrans %}</button>
{% endcall %}

{#
Those messages are similar to those in _protection_messages.html but can be used
purely client-side and are worded for event creation instead of being generic.
#}
<script type="text/html" id="event-creation-protection-messages">
    <div class="action-box for-form protection-message public-protection-message accept">
        <div class="section">
            <div class="icon icon-unlocked"></div>
            <div class="text">
                <div class="label">
                    {% trans %}Public{% endtrans %}
                </div>
                <div>
                    {% trans -%}
                        The event will be publicly accessible since it is set as public.
                    {%- endtrans %}
                </div>
            </div>
        </div>
    </div>

    <div class="action-box for-form protection-message protected-protection-message danger">
        <div class="section">
            <div class="icon icon-lock"></div>
            <div class="text">
                <div class="label">
                    {% trans %}Protected{% endtrans %}
                </div>
                <div>
                    {% trans -%}
                        The event will <strong>only</strong> be accessible by the <strong>managers</strong> of
                        <strong>parent categories</strong> and users you give access to.
                    {%- endtrans %}
                </div>
            </div>
        </div>
    </div>

    <div class="action-box for-form protection-message inheriting-protected-protection-message warning">
        <div class="section">
            <div class="icon icon-lock"></div>
            <div class="text">
                <div class="label">
                    {% trans %}Protected{% endtrans %}
                </div>
                <div>
                    {% trans -%}
                        This event will not be publicly accessible since the category <strong class="js-category-title"></strong> is protected.
                    {%- endtrans %}
                </div>
            </div>
        </div>
    </div>

    <div class="action-box for-form protection-message inheriting-public-protection-message accept">
        <div class="section">
            <div class="icon icon-unlocked"></div>
            <div class="text">
                <div class="label">
                    {% trans %}Public{% endtrans %}
                </div>
                <div>
                    {% trans -%}
                        This event will be publicly accessible since the category <strong class="js-category-title"></strong> is not protected.
                    {%- endtrans %}
                </div>
            </div>
        </div>
    </div>
</script>

<script>
    setupEventCreationDialog({
        categoryField: $('#{{ form.category.id }}'),
        protectionModeFields: $('input[name={{ form.protection_mode.name }}][id^={{ form.protection_mode.id }}]'),
        initialCategory: {{ category | tojson }}
    });

    _.defer(function() {
        $('#{{ form.title.id }}').focus();
    });

    $("#event-creation-location_data").change(function() {
        var roomData = JSON.parse($(this).val());
        if ('room_id' in roomData) {
            var $container = $('#availability-container').empty().removeClass();
            var $messageContent = $('<div>', {
                class: 'message-box-content'
            });
            var $messageIcon = $('<span>', {
                class: 'icon'
            });
            $messageIcon.appendTo($messageContent);
            $messageContent.appendTo($container);

            var $availableMessage = $('<div>', {
                class: 'message-text',
                text: 'This room is available. Would you like to book it?'
            });
            var $conflictBookingMessage = $('<div>', {
                class: 'message-text',
                text: 'There are conflicting bookings'
            });
            var $conflictPrebookingMessage = $('<div>', {
                class: 'message-text',
                text: 'There are conflicting prebookings'
            });
            var roomId = roomData['room_id'];
            var startDate = $('#event-creation-start_dt-date').val();
            var startTime = $('#event-creation-start_dt-time').val();
            var endDate = $('#event-creation-end_dt-date').val();
            var endTime = $('#event-creation-end_dt-time').val();
            var startDt = moment(startDate + " " + startTime, 'DD/MM/YYYY HH:mm').format('DD/MM/YYYY HH:mm:ss');
            var endDt = moment(endDate + " " + endTime, 'DD/MM/YYYY HH:mm').format('DD/MM/YYYY HH:mm:ss');
            var requestParams = {room_id: roomId, start_dt: startDt, end_dt: endDt};
            $.ajax({
                url: build_url(Indico.Urls.RoomBooking.room.check_available, requestParams),
                method: 'GET',
                dataType: 'json',
                contentType: 'application/json',
                error: handleAjaxError,
                success: function(data) {
                    if (data['conflict_booking']){
                        $container.addClass('error-message-box')
                        $conflictBookingMessage.appendTo($messageContent);
                    } else if (data['conflict_prebooking']){
                        $container.addClass('warning-message-box')
                        $conflictPrebookingMessage.appendTo($messageContent);
                    } else {
                        var $switch = $('<input>', {type: 'checkbox'});
                        $container.addClass('success-message-box')
                        $availableMessage.appendTo($messageContent);
                        $switch.appendTo($messageContent);
                    }
                    $container.show();
                }
            });
        }
    });
</script>
