{% from 'forms/_form.html' import form_header, form_footer, form_rows, form_row, form_fieldset %}
{% set category = {'id': form.category.data.id,
                   'is_protected': form.category.data.is_protected,
                   'title': form.category.data.title} if form.category.data else none %}

{{ form_header(form, action=url_for('events.create', event_type=event_type)) }}
{{ form_row(form.category, orientation=('hidden' if single_category else '')) }}
{{ form_rows(form, fields=form._field_order) }}
{% if form._advanced_field_order %}
    {% call form_fieldset(_('Advanced'), collapsible=true) %}
        {{ form_rows(form, fields=form._advanced_field_order) }}
    {% endcall %}
{% endif %}
{% call form_footer(form) %}
    <input class="i-button big highlight" type="submit" value="{% trans %}Create event{% endtrans %}"
           data-disabled-until-change>
    <button type="button" class="i-button big" data-button-back>{% trans %}Cancel{% endtrans %}</button>
{% endcall %}

{#
Those messages are similar to those in _protection_messages.html but can be used
purely client-side and are worded for event creation instead of being generic.
#}
<script type="text/html" id="event-creation-protection-messages">
    <div class="action-box for-form protection-message public-protection-message accept">
        <div class="section">
            <div class="icon icon-unlocked"></div>
            <div class="text">
                <div class="label">
                    {% trans %}Public{% endtrans %}
                </div>
                <div>
                    {% trans -%}
                        The event will be publicly accessible since it is set as public.
                    {%- endtrans %}
                </div>
            </div>
        </div>
    </div>

    <div class="action-box for-form protection-message protected-protection-message danger">
        <div class="section">
            <div class="icon icon-lock"></div>
            <div class="text">
                <div class="label">
                    {% trans %}Protected{% endtrans %}
                </div>
                <div>
                    {% trans -%}
                        The event will <strong>only</strong> be accessible by the <strong>managers</strong> of
                        <strong>parent categories</strong> and users you give access to.
                    {%- endtrans %}
                </div>
            </div>
        </div>
    </div>

    <div class="action-box for-form protection-message inheriting-protected-protection-message warning">
        <div class="section">
            <div class="icon icon-lock"></div>
            <div class="text">
                <div class="label">
                    {% trans %}Protected{% endtrans %}
                </div>
                <div>
                    {% trans -%}
                        This event will not be publicly accessible since the category <strong class="js-category-title"></strong> is protected.
                    {%- endtrans %}
                </div>
            </div>
        </div>
    </div>

    <div class="action-box for-form protection-message inheriting-public-protection-message accept">
        <div class="section">
            <div class="icon icon-unlocked"></div>
            <div class="text">
                <div class="label">
                    {% trans %}Public{% endtrans %}
                </div>
                <div>
                    {% trans -%}
                        This event will be publicly accessible since the category <strong class="js-category-title"></strong> is not protected.
                    {%- endtrans %}
                </div>
            </div>
        </div>
    </div>
</script>

<script>
    setupEventCreationDialog({
        categoryField: $('#{{ form.category.id }}'),
        protectionModeFields: $('input[name={{ form.protection_mode.name }}][id^={{ form.protection_mode.id }}]'),
        initialCategory: {{ category | tojson }}
    });

    _.defer(function() {
        $('#{{ form.title.id }}').focus();
    });
</script>

{% if check_room_availability %}
    <script>
        var rbExcludedCategories = {{ rb_excluded_categories | tojson }}
        var serverDefaultTimezone = '{{ indico_config.DEFAULT_TIMEZONE }}';
        var availabilityDisplayed = false;
        var previousRoomId;
        var $currentMessage;

        var startDt;
        var endDt;
        var category;
        var roomData;
        var timezone;
        var category;

        var $createBooking = $('#event-creation-create_booking');
        var $availableMessage = $('#room-available');
        var $conflictBookingMessage = $('#room-conflict-booking');
        var $conflictPrebookingMessage = $('#room-conflict-prebooking');
        var $availableDisabled = $('#room-available-disabled');
        var $availableDisabledContent = $('#available-disabled-message');
        var $conflictPrebookingDisabled = $('#conflict-prebooking-disabled');
        var $conflictPrebookingDisabledContent = $('#conflict-prebooking-disabled-message');
        var $blacklistedCategoryContent = $('<strong></strong>').text("You can't book a room for an event in this category");
        var $differentTimezoneContent = $('<strong></strong>').text("You can't book a room for an event in a different timezone than: " + serverDefaultTimezone);

        function setLectureTimes(occurrence){
            startDt = moment(occurrence['date'] + " " + occurrence['time'], 'DD-MM-YYYY HH:mm');
            endDt = moment(startDt).add(occurrence['duration'], 'minutes');
        }

        function initValues() {
            var startDate = $('#event-creation-start_dt-date').val();
            var startTime = $('#event-creation-start_dt-time').val();
            var endDate = $('#event-creation-end_dt-date').val();
            var endTime = $('#event-creation-end_dt-time').val();
            var occurrences = $('#event-creation-occurrences').val();

            roomData = JSON.parse($("#event-creation-location_data").val());
            timezone = $('#event-creation-timezone').val();
            category = JSON.parse($("#event-creation-category").val());

            if (occurrences && occurrences.length === 1) {
                setLectureTimes(JSON.parse(occurrences[0]));
            } else {
                startDt = moment(startDate + " " + startTime, 'DD/MM/YYYY HH:mm');
                endDt = moment(endDate + " " + endTime, 'DD/MM/YYYY HH:mm');
            }
        }

        initValues();

        function isCategoryExcluded(categoryId) {
            var isExcluded = false;
            rbExcludedCategories.forEach( function (excludedCategory) {
                if (parseInt(excludedCategory.id) === categoryId) {
                    isExcluded = true;
                }
            });
            return isExcluded;
        }

        function checkConditions() {
            if (isCategoryExcluded(category['id'])) { return $blacklistedCategoryContent; }
            if (timezone !== serverDefaultTimezone) {return $differentTimezoneContent; }
            return false;
        }

        function hideAvailability() {
            if ($currentMessage) {
                $currentMessage.hide();
            }
        }

        function updateAvailability() {
            hideAvailability();

            if (!('room_id' in roomData) || !(startDt.isSame(endDt, 'day'))) {
                $createBooking.val(false);
                return;
             }

            var roomId = roomData['room_id'];
            previousRoomId = roomId;

            var requestParams = {
                room_id: roomId,
                start_dt: startDt.format('DD/MM/YYYY HH:mm:ss'),
                end_dt: endDt.format('DD/MM/YYYY HH:mm:ss')
            };

            $.ajax({
                url: build_url(Indico.Urls.RoomBooking.room.check_available, requestParams),
                method: 'GET',
                dataType: 'json',
                contentType: 'application/json',
                error: handleAjaxError,
                success: function(data) {
                    if (data['conflict_booking']){
                        $currentMessage = $conflictBookingMessage;
                        $createBooking.val(false);
                        availabilityDisplayed = true;
                    } else if (data['conflict_prebooking']){
                        var message = checkConditions();
                        if (message) {
                            if (availabilityDisplayed) {
                                $conflictPrebookingDisabledContent.empty();
                                $conflictPrebookingDisabledContent.append(message);
                                $currentMessage = $conflictPrebookingDisabled;
                            }
                            $createBooking.val(false);
                        }
                        $currentMessage = $conflictPrebookingMessage;
                        availabilityDisplayed = true;
                    } else {
                        var message = checkConditions();
                        if (message) {
                            if (availabilityDisplayed) {
                                $availableDisabledContent.empty();
                                $availableDisabledContent.append(message);
                                $currentMessage = $availableDisabled;
                            }
                            $createBooking.val(false);
                        } else {
                            $currentMessage = $availableMessage;
                            availabilityDisplayed = true;
                        }
                    }
                    $currentMessage.show();
                }
            });
        }

        $("#event-creation-location_data").change(function() {
            roomData = JSON.parse($(this).val());
            if (previousRoomId !== roomData['room_id']) {
                updateAvailability();
            }
        });

        $('#event-creation-start_dt-date').change(function() {
            var startDate = $(this).val();
            var startTime = $('#event-creation-start_dt-time').val();
            var endDate = $('#event-creation-end_dt-date').val();
            var endTime = $('#event-creation-end_dt-time').val();
            startDt = moment(startDate + " " + startTime, 'DD/MM/YYYY HH:mm');
            endDt = moment(endDate + " " + endTime, 'DD/MM/YYYY HH:mm');
            // workaround for automatic end date update if start date is after end date
            if (endDt.isBefore(startDt)) {
                endDt = moment(startDate + " " + endTime, 'DD/MM/YYYY HH:mm');
            }
            updateAvailability();
        });

        $('#event-creation-start_dt-time').change(function() {
            var startDate = $('#event-creation-start_dt-date').val();
            var startTime = $('#event-creation-start_dt-time').val();
            startDt = moment(startDate + " " + startTime, 'DD/MM/YYYY HH:mm');
            updateAvailability();
        });

        $('#event-creation-end_dt-date').change(function() {
            var endDate = $(this).val();
            var endTime = $('#event-creation-end_dt-time').val();
            endDt = moment(endDate + " " + endTime, 'DD/MM/YYYY HH:mm');
            updateAvailability();
        });

        $('#event-creation-end_dt-time').change(function() {
            var endDate = $('#event-creation-end_dt-date').val();
            var endTime = $(this).val()
            endDt = moment(endDate + " " + endTime, 'DD/MM/YYYY HH:mm');
            updateAvailability();
        });

        $('#event-creation-occurrences').change(function() {
            var occurrences = JSON.parse($(this).val());
            if (occurrences.length === 1) {
                setLectureTimes(occurrences[0]);
                updateAvailability();
            } else {
                hideAvailability();
            }
        });

        $('#event-creation-timezone').change(function() {
            timezone = ($(this).val());
            updateAvailability();
        });

        $('#event-creation-category').change(function() {
            category = JSON.parse($(this).val());
            updateAvailability();
        })

        $('#create-booking').change (function() {
            $createBooking.val(this.checked);
        });

        $('#create-booking-over-prebooking').change (function() {
            $createBooking.val(this.checked);
        });
    </script>
{% endif %}
