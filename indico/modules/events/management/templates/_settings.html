{% macro with_default(content='') %}
    {% set content = (caller() if caller is defined else content) | trim %}
    {%- if content -%}
        {{ content }}
    {%- else -%}
        <span class="no-value">{% trans %}None{% endtrans %}</span>
    {%- endif -%}
{% endmacro %}


{% macro render_section(event, icon, edit_endpoint, edit_title) %}
    <div class="section">
        <div class="icon {{ icon }}"></div>
        <div class="text">
            {{ caller() }}
        </div>
        <div class="toolbar">
            <button class="i-button borderless text-color icon-only icon-edit"
                    title="{{ edit_title }}"
                    data-href="{{ url_for(edit_endpoint, event) }}"
                    data-title="{{ edit_title }}"
                    data-update='{"settings_box": "#event-settings-container",
                                  "right_header": "#event-management-header-right"}'
                    data-ajax-dialog></button>
        </div>
    </div>
{% endmacro %}


{% macro render_event_settings(event) %}
    {% call render_section(event, 'icon-home', '.edit_data', _('Edit basic event data')) %}
        <dl class="i-data-list">
            <dt>{% trans %}Title{% endtrans %}</dt>
            <dd>{{ event.title }}</dd>

            <dt>{% trans %}Description{% endtrans %}</dt>
            <dd>{{ with_default(event.description|striptags)|truncate(200) }}</dd>

            <dt>{% trans %}Short URL{% endtrans %}</dt>
            <dd>
                {% call with_default() %}
                    {% if event.url_shortcut %}
                        <a href="{{ event.short_external_url }}"
                           class="js-copy-to-clipboard"
                           title="{% trans %}Copy link to clipboard{% endtrans %}"
                           data-clipboard-text="{{ event.short_external_url }}"
                           data-clipboard-action="copy">
                            {{ event.short_external_url }}
                        </a>
                    {% endif %}
                {% endcall %}
            </dd>
        </dl>
    {% endcall %}

    {% call render_section(event, 'icon-calendar', '.edit_dates', _('Edit event dates')) %}
        {% set tz = event.tzinfo %}

        <dl class="i-data-list">
            <dt>{% trans %}Date{% endtrans %}</dt>
            <dd>
                {% if event.start_dt.astimezone(tz).date() == event.end_dt.astimezone(tz).date() %}
                    {{ event.start_dt|format_date('long', timezone=tz) }}
                {% else %}
                    {{ event.start_dt|format_date(timezone=tz) }} - {{ event.end_dt|format_date(timezone=tz) }}
                {% endif %}
            </dd>

            <dt>{% trans %}Time{% endtrans %}</dt>
            <dd>{{ event.start_dt|format_time(timezone=tz) }} - {{ event.end_dt|format_time(timezone=tz) }}</dd>

            <dt>{% trans %}Timezone{% endtrans %}</dt>
            <dd>{{ event.timezone }}</dd>

            {% if event.type == 'conference' %}
                <dt>{% trans %}Screen dates{% endtrans %}</dt>
                <dd>
                    {% if event.start_dt_override or event.end_dt_override %}
                        {{ event.start_dt_display | format_datetime(timezone=tz) }} -
                        {{ event.end_dt_display | format_datetime(timezone=tz) }}
                    {% else %}
                        {{ with_default() }}
                    {% endif %}
                </dd>
            {% endif %}
    {% endcall %}

    {% call render_section(event, 'icon-location', '.edit_location', _('Edit event location')) %}
        <dl class="i-data-list">
            <dt>{% trans %}Room{% endtrans %}</dt>
            <dd>{{ with_default(event.room_name) }}</dd>

            <dt>{% trans %}Venue{% endtrans %}</dt>
            <dd>{{ with_default(event.venue_name) }}</dd>

            <dt>{% trans %}Address{% endtrans %}</dt>
            <dd>{{ with_default(event.address|replace('\n', '<br>'|safe)) }}</dd>
        </dl>
    {% endcall %}

    {% set edit_persons_title = _('Edit speakers') if event.type == 'lecture' else _('Edit chairpersons') %}
    {% call render_section(event, 'icon-user-chairperson', '.edit_persons', edit_persons_title) %}
        <dl class="i-data-list">
            <dt>
                {%- if event.type == 'lecture' -%}
                    {% trans %}Speakers{% endtrans %}
                {%- else -%}
                    {% trans %}Chairpersons{% endtrans %}
                {%- endif -%}
            </dt>
            <dd>
                {% call with_default() %}
                    {% for event_person_link in event.person_links | sort(attribute='display_order_key') %}
                        <div>
                            <span>{{ event_person_link.display_full_name }}</span>
                            {% if event_person_link.is_submitter %}
                                <span class="badge">{% trans %}Submitter{% endtrans %}</span>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endcall %}
            </dd>
        </dl>
    {% endcall %}

    {% call render_section(event, 'icon-info', '.edit_contact_info', _('Edit contact info')) %}
        <dl class="i-data-list">
            {% if event.type == 'lecture' %}
                <dt>{% trans %}Organiser{% endtrans %}</dt>
                <dd>{{ with_default(event.organizer_info|truncate(200)) }}</dd>
            {% endif %}

            {% if event.type == 'conference' %}
                <dt>{% trans %}Additional info{% endtrans %}</dt>
                <dd>{{ with_default(event.additional_info|striptags|truncate(200)) }}</dd>
            {% endif %}

            <dt>{% trans %}Contact title{% endtrans %}</dt>
            <dd>{{ with_default(event.contact_title) }}</dd>

            <dt>{% trans %}Email{% endtrans %}</dt>
            <dd>{{ with_default(event.contact_emails|join(', ')) }}</dd>

            <dt>{% trans %}Phone{% endtrans %}</dt>
            <dd>{{ with_default(event.contact_phones|join(', ')) }}</dl>
        </dl>
    {% endcall %}

    {% set edit_cls_title = _('Edit keywords / references') if event.type == 'meeting' else _('Edit keywords') %}
    {% call render_section(event, 'icon-tag', '.edit_classification', edit_cls_title) %}
        <dl class="i-data-list">
            <dt>{% trans %}Keywords{% endtrans %}</dt>
            <dd>
                {% call with_default() %}
                    {% for keyword in event.keywords %}
                        <span class="badge">{{ keyword }}</span>
                    {% endfor %}
                {% endcall %}
            </dd>
            {% if event.type == 'meeting' %}
                <dt>{% trans %}External IDs{% endtrans %}</dt>
                <dd>
                    {% call with_default() %}
                        {% set references = event.references|sort(attribute='value')|sort(attribute='reference_type.name') %}
                        {% if references %}
                            {% for reference in references -%}
                                {{ reference.value }} ({{ reference.reference_type.name }})
                                {% if not loop.last %}<br>{% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endcall %}
                </dd>
            {% endif %}
        </dl>
    {% endcall %}
{% endmacro %}
