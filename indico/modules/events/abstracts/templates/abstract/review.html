{% from 'forms/_form.html' import form_header, form_rows, form_footer %}
{% from 'events/abstracts/abstract/_common.html' import render_edited_hint, render_tracks %}

{% macro render_abstract_reviews(abstract, review_forms, management=false) %}
    <div id="abstract-reviews" class="i-timeline">
        {% for track in abstract.reviewed_for_tracks %}
            {% set reviews = abstract.reviews|selectattr('track', 'equalto', track)|list %}
            {% if not abstract.can_see_reviews(session.user) %}
                {% set reviews = reviews|selectattr('user', 'equalto', session.user)|list %}
            {% endif %}
            {% if reviews %}
                <h3>
                    {% trans title=track.title -%}
                        Track: {{ title }}
                    {%- endtrans %}
                </h3>
                {% for review in reviews %}
                    {{ _render_review(abstract.event_new.cfa, review, review_forms[track.id], management=management) }}
                {% endfor %}
            {% endif %}
        {% endfor %}
    </div>
{% endmacro %}

{% macro render_review_boxes(abstract, review_forms, management=false) %}
    {% for track in abstract.reviewed_for_tracks|sort(attribute='title') %}
        {% set user_reviewed = abstract.get_reviews(track=track)|selectattr('user', 'equalto', session.user)|list %}
        {% if not user_reviewed and track.can_review_abstracts(session.user) %}
            {{ render_review_box(review_forms[track.id], abstract, track, management=management) }}
        {% endif %}
    {% endfor %}
{% endmacro %}

{% macro render_review_box(form, abstract, track, edit=false, management=false) %}
    <div id="abstract-review-box-{{ track.id }}"
         class="i-timeline-item abstract-review-box {{'weak-hidden' if edit else ''}}">
        <div class="i-timeline-item-label action icon-checkmark"></div>
        <div class="i-timeline-item-box content-indicator">
            <div class="i-box-content">
                <div class="flex">
                    <div class="stretch">
                        <strong>
                            {% trans track_title=track.title -%}
                                Review for track "{{ track_title }}"
                            {%- endtrans %}
                        </strong>
                    </div>
                </div>
            </div>
            <div class="i-box-footer">
                {{ form_header(form, orientation='vertical', id=('track-review-form-' + track.id|string)) }}
                {{ form_rows(form, skip=form._order) }}
                {{ form_rows(form, fields=form._order) }}
                {% set form_id = '#track-review-form-' + track.id|string %}
                {% call form_footer(form, skip_label=skip_labels) %}
                    <button class="i-button big highlight js-review"
                            data-method="POST"
                            data-href="{{ url_for('.review_abstract', abstract, track, management=management) }}">
                        {% if edit %}
                            {% trans %}Change{% endtrans %}
                        {% else %}
                            {% trans %}Review{% endtrans %}
                        {% endif %}
                    </button>
                {% endcall %}
            </div>
        </div>
    </div>
{% endmacro %}

{% macro render_comments_section(abstract, form=none) %}
    {% set can_comment = abstract.can_comment(session.user) %}
    {% if abstract.comments or can_comment %}
        <div id="abstract-comments" class="i-timeline">
            <h3>
                {%- trans %}Comments{% endtrans -%}
            </h3>
            {% for comment in abstract.comments %}
                <div class="i-timeline-item">
                    <div class="i-timeline-item-label action"></div>
                    <div class="i-timeline-item-box header-indicator">
                        <div class="i-box-header flex">
                            <div class="stretch">
                                {% trans name=comment.user.name, date=comment.created_dt|format_date -%}
                                    <strong>{{ name }}</strong> commented on {{ date }}
                                {%- endtrans %}
                                {% if comment.modified_dt %}
                                    {{ render_edited_hint(comment.modified_dt, comment.modified_by) }}
                                {% endif %}
                            </div>
                            {% if comment.can_edit(session.user) %}
                                <div class="abstract-comment-badges">
                                    <a class="i-button-icon icon-edit js-edit-comment"
                                       title="{% trans %}Edit comment{% endtrans %}"
                                       data-href="{{ url_for('.edit_abstract_comment', comment) }}"
                                       data-method="GET"
                                       data-ajax></a>
                                    <a class="i-button-icon icon-cross js-delete-comment"
                                       title="{% trans %}Remove comment{% endtrans %}"
                                       data-method="POST"
                                       data-href="{{ url_for('.delete_abstract_comment', comment) }}"
                                       data-title="{% trans %}Remove comment{% endtrans %}"
                                       data-confirm="{% trans %}Are you sure you want to remove this comment?{% endtrans %}"
                                       data-ajax>
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                        <div class="i-box-content">
                            {{ comment.text }}
                        </div>
                    </div>
                </div>
            {% endfor %}
            {% if can_comment %}
                {{ render_comment_box(abstract, form) }}
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}

{% macro render_comment_box(abstract, form) %}
    <div id="abstract-comment-box" class="i-timeline-item">
        <div class="i-timeline-item-label action icon-file"></div>
        <div class="i-timeline-item-box footer-only header-indicator">
            <div class="i-box-footer">
                {{ render_comment_form(form, abstract) }}
            </div>
        </div>
    </div>
{% endmacro %}

{% macro render_comment_form(form, abstract, comment=none) %}
    {% set url = url_for('.edit_abstract_comment', comment) if comment else url_for('.comment_abstract', abstract) %}
    {{ form_header(form, orientation='vertical') }}
    {{ form_rows(form, skip_labels=true) }}
    {% call form_footer(form) %}
        <button class="i-button big highlight text-color js-comment"
                data-method="POST"
                data-href="{{ url }}">
            {% if comment %}
                {% trans %}Update comment{% endtrans %}
            {% else %}
                {% trans %}Comment{% endtrans %}
            {% endif %}
        </button>
        {% if comment %}
            <button class="i-button big text-color danger js-edit-comment-cancel"
                    data-confirm="{% trans %}Do you want to discard the changes to this comment?{% endtrans %}">
                {% trans %}Cancel{% endtrans %}
            </button>
        {% endif %}
    {% endcall %}
{% endmacro %}

{% macro _render_review_state(review) %}
    {% set mapping = {'accept': 'success',
                      'reject': 'error',
                      'merge': 'visited',
                      'mark_as_duplicate': 'strong',
                      'change_tracks': 'warning'} %}
    <span class="i-tag outline {{ mapping[review.proposed_action.name] }}">
        {{ review.proposed_action.title -}}
    </span>
{% endmacro %}

{% macro _render_rating(cfa, value) %}
    <span class="rating">
        {%- for bullet in range(cfa.rating_range[0], cfa.rating_range[1] + 1) -%}
            <span class="bullet {{ 'full' if bullet <= value else '' }}"></span>
        {%- endfor -%}
    </span>
{% endmacro %}

{% macro _render_review(cfa, review, form, management=false) %}
    {% set can_change_review = review.user == session.user and review.abstract.public_state.name == 'under_review' %}
    <div class="i-timeline-item">
        <div class="i-timeline-item-label action abstract-comment-pic"></div>
        <div class="i-timeline-item-box header-indicator review-results">
            <div class="i-box-header flex">
                <div class="stretch">
                    {% trans name=review.user.name -%}
                        <strong>{{ name }}</strong> reviewed this abstract
                    {%- endtrans %}
                    {% if review.modified_dt %}
                        {{ render_edited_hint(review.modified_dt) }}
                    {% endif %}
                    <time datetime="{{ review.created_dt.isoformat() }}">
                        {{- review.created_dt|format_human_date -}}
                    </time>
                </div>
                <div class="abstract-comment-badges">
                    <span>
                        {% trans action=_render_review_state(review) %}
                            Proposes to {{ action }}
                        {% endtrans %}
                    </span>
                    {% if review.score %}
                        {% set score = review.score %}
                        {% set max_score = cfa.rating_range[1]|round(1) %}
                        <span class="i-tag highlight outline" title="{% trans %}Score: {{ score }} / {{ max_score }}{% endtrans %}">
                            {{ score }}
                        </span>
                    {% endif %}
                </div>
                {% if can_change_review %}
                    <div>
                        <a class="i-button-icon icon-edit js-change-review"
                           title="{% trans %}Change review{% endtrans %}"></a>
                    </div>
                {% endif %}
            </div>
            {% set contribution_type = review.proposed_contribution_type %}
            {% if review.proposed_action.name == 'accept' and contribution_type %}
                <div class="i-box-content">
                    {% set contribution_type -%}
                        <strong>{{ contribution_type.name|escape }}</strong>
                    {%- endset %}
                    {% trans type=contribution_type|safe -%}
                        Proposed to accept as {{ type }}
                    {%- endtrans %}
                </div>
            {% elif review.proposed_action.name == 'change_tracks' %}
                <div class="i-box-content">
                    {% set tracks -%}
                        {% for track in review.proposed_tracks -%}
                            <span class="abstract-track">{{ track.title|escape }}</span>
                            {%- if not loop.last -%}, {% endif -%}
                        {% endfor %}
                    {%- endset %}
                    {% trans count=review.proposed_tracks|length, tracks=tracks|safe -%}
                        Possible destination track: {{ tracks }}
                    {%- pluralize -%}
                        Possible destination tracks: {{ tracks }}
                    {%- endtrans %}
                </div>
            {% elif review.proposed_action.name in ('mark_as_duplicate', 'merge') %}
                <div class="i-box-content">
                    {% set other_abstract = review.proposed_related_abstract %}
                    {% set abstract_link -%}
                        <a href="{{ url_for('.display_abstract', other_abstract) }}">
                            {{ other_abstract.title|escape }}
                        </a>
                    {%- endset %}
                    {% if review.proposed_action.name == 'merge' %}
                        {% trans title=abstract_link|safe -%}
                            Proposed to be merged into {{ title }}
                        {%- endtrans %}
                    {% elif review.proposed_action.name == 'mark_as_duplicate' %}
                        {% trans title=abstract_link|safe -%}
                            Proposed as duplicate of {{ title }}
                        {%- endtrans %}
                    {% endif %}
                </div>
            {% endif %}
            {% if review.ratings %}
                <div class="titled-rule">
                    {% trans %}Ratings{% endtrans %}
                </div>
                {% for rating in review.ratings|sort(attribute='question.position') %}
                    <ul class="abstract-question-list">
                        <li>
                            <label>{{ rating.question.text }}</label>
                            <span class="value">
                                {{ _render_rating(cfa, rating.value) }}
                                <span class="number">{{ rating.value }}</span>
                            </span>
                        </li>
                    </ul>
                {% endfor %}
            {% endif %}
            {% if review.comment %}
                <div class="titled-rule">
                    {% trans %}Comment{% endtrans %}
                </div>
                <div class="i-box-content">
                    {{ review.comment }}
                </div>
            {% endif %}
        </div>
    </div>
    {% if can_change_review %}
        {{ render_review_box(form, review.abstract, review.track, edit=true, management=management) }}
    {% endif %}
{% endmacro %}

{% macro render_reviewed_for_tracks_box(abstract, form, management=false) %}
    <div id="abstract-reviewed-for-tracks-box" class="i-timeline-item">
        <div class="i-timeline-item-label action icon-list"></div>
        <div class="i-timeline-item-box content-indicator">
            <div class="i-box-content">
                <div class="flex">
                    <div class="stretch">
                        <div class="info-line">
                            <label>
                                {% trans count=abstract.reviewed_for_tracks|length -%}
                                    Reviewing for track:
                                {%- pluralize -%}
                                    Reviewing for tracks:
                                {%- endtrans -%}
                            </label>
                            {{ render_tracks(abstract.reviewed_for_tracks) }}
                        </div>
                    </div>
                    {% if abstract.edit_track_mode.name != 'none' %}
                        <div>
                            <a href="#" id="edit-reviewed-for-track-list">
                                {%- trans %}Edit track list{% endtrans -%}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="i-box-footer hidden">
                <span>{% trans %}The abstract is being reviewed for the following tracks:{% endtrans %}</span>
                {{ form_header(form) }}
                {{ form_rows(form, skip_labels=true) }}
                {% call form_footer(form, skip_label=true) %}
                    <button class="i-button big highlight"
                            id="save-reviewing-tracks-list"
                            data-method="POST"
                            data-href="{{ url_for('.edit_review_tracks', abstract, management=management) }}">
                        {%- trans %}Save{% endtrans -%}
                    </button>
                {% endcall %}
            </div>
        </div>
    </div>
{% endmacro %}
