{% from 'events/abstracts/abstract/_common.html' import render_edited_hint, render_tracks %}

{% macro _render_submission_info(abstract, management) %}
    {% if abstract.submitted_contrib_type %}
        <div class="info-line">
            <label>
                {% trans %}Contribution type:{% endtrans %}
            </label>
            {{ abstract.submitted_contrib_type.name }}
        </div>
    {% endif %}
    {% if abstract.submitted_for_tracks %}
        <div class="info-line">
            <label>
                {% trans count=abstract.submitted_for_tracks|length -%}
                    Track:
                {%- pluralize -%}
                    Tracks:
                {%- endtrans -%}
            </label>
            {{ render_tracks(abstract.submitted_for_tracks) }}
        </div>
    {% endif %}
    {% if abstract.primary_authors %}
        <div class="info-line">
            <label>
                {% trans count=abstract.primary_authors|length -%}
                    Author
                {%- pluralize -%}
                    Authors
                {%- endtrans %}
            </label>
            <ul class="author-list">
                {% for user in abstract.primary_authors|sort(attribute='display_order_key') -%}
                    <li class="event-user">
                        {{ user.full_name }}
                    </li>
                {%- endfor %}
            </ul>
        </div>
    {% endif %}
    {% if abstract.secondary_authors %}
        <div class="info-line">
            <label>
                {% trans count=abstract.secondary_authors|length -%}
                    Co-author
                {%- pluralize -%}
                    Co-authors
                {%- endtrans %}
            </label>
            <ul class="author-list">
                {% for user in abstract.secondary_authors|sort(attribute='display_order_key') -%}
                    <li class="event-user">
                        {{ user.full_name }}
                    </li>
                {%- endfor %}
            </ul>
        </div>
    {% endif %}
    {% if abstract.speakers %}
        <div class="info-line">
            <label>
                {% trans count=abstract.speakers|length -%}
                    Speaker
                {%- pluralize -%}
                    Speakers
                {%- endtrans %}
            </label>
            <ul class="author-list">
                {% for user in abstract.speakers -%}
                    <li class="event-user">
                        {{ user.full_name }}
                    </li>
                {%- endfor %}
            </ul>
        </div>
    {% endif %}
    <div class="info-line submitted-data">
        {% if abstract.field_values %}
            <dl class="custom-field-values field-separator">
                {% for value in abstract.field_values|sort(attribute='contribution_field.position')
                   if value.contribution_field.is_active %}
                    {{ _render_field_value(value) }}
                {% endfor %}
            </dl>
        {% endif %}
        {% if abstract.submission_comment %}
            <div class="comment">
                <div class="titled-rule">
                    {% trans %}Comment{% endtrans %}
                </div>
                {{ abstract.submission_comment }}
            </div>
        {% endif %}
    </div>
{% endmacro %}

{% macro _render_summary_state(abstract) %}
    {% set mapping = {'under_review': 'highlight',
                      'withdrawn': 'outline dashed',
                      'accepted': 'success',
                      'rejected': 'error',
                      'merged': 'visited',
                      'duplicate': 'strong'} %}
    <div class="i-tag {{ mapping[abstract.public_state.name] }}">
        {{ abstract.public_state.title }}
    </div>
{% endmacro %}

{% macro _render_abstract_summary(abstract, management=false) %}
    <div class="abstract-summary">
        <div class="abstract-summary-badge">
            {{ _render_summary_state(abstract) }}
        </div>
        <div class="abstract-summary-content">
            {% if abstract.state.name in ('submitted', 'withdrawn', 'rejected') %}
                <div>
                    {% if abstract.submitted_contrib_type %}
                        {% trans name=abstract.submitter.name, type=abstract.submitted_contrib_type.name|lower -%}
                            <strong>{{ name }}</strong> submitted this <span class="abstract-contribution-type">{{ type }}</span>
                        {%- endtrans %}
                    {% else %}
                        {% trans name=abstract.submitter.name -%}
                            <strong>{{ name }}</strong> submitted this abstract
                        {%- endtrans %}
                    {% endif %}
                </div>
                {% if abstract.submitted_for_tracks %}
                    <div>
                        {% trans count=abstract.submitted_for_tracks|length -%}
                            For track:
                        {%- pluralize -%}
                            For tracks:
                        {%- endtrans %}
                        {{ render_tracks(abstract.submitted_for_tracks) }}
                    </div>
                {% endif %}
            {% elif abstract.state.name == 'accepted' %}
                <div>
                    {% if abstract.accepted_contrib_type and abstract.accepted_track %}
                        {% trans name=abstract.submitter.name,
                            type=abstract.accepted_contrib_type.name,
                            track=abstract.accepted_track.title -%}
                            <strong>{{ name }}</strong> submitted this abstract and it was finally accepted
                            for track <span class="abstract-track">{{ track }}</span>
                            as <span class="abstract-contribution-type">{{ type }}</span>.
                        {% endtrans %}
                    {% elif abstract.accepted_contrib_type %}
                        {% trans name=abstract.submitter.name,
                            type=abstract.accepted_contrib_type.name -%}
                            <strong>{{ name }}</strong> submitted this abstract and it was finally accepted
                            as <span class="abstract-contribution-type">{{ type }}</span>.
                        {% endtrans %}
                    {% elif abstract.accepted_track %}
                        {% trans name=abstract.submitter.name,
                            track=abstract.accepted_track.title -%}
                            <strong>{{ name }}</strong> submitted this abstract and it was finally accepted
                            for track <span class="abstract-track">{{ track }}</span>.
                        {% endtrans %}
                    {% else %}
                        {% trans name=abstract.submitter.name -%}
                            <strong>{{ name }}</strong> submitted this abstract and it was finally accepted.
                        {%- endtrans %}
                    {% endif %}
                </div>
                <div>
                    {% if abstract.contribution %}
                        <a href="{{ url_for('contributions.display_contribution', abstract.contribution) }}">
                            {% trans %}Go to contribution{%- endtrans %}
                        </a>
                    {% endif %}
                </div>
            {% elif abstract.state.name == 'merged' %}
                <div>
                    {% trans name=abstract.submitter.name -%}
                        <strong>{{ name }}</strong> submitted this abstract but it was merged into another.
                    {%- endtrans %}
                </div>
                {% if abstract.merged_into.can_access(session.user) %}
                    <div>
                        {% trans url=url_for('.display_abstract', abstract.merged_into) %}
                            <a href="{{ url }}">Go to abstract</a>
                        {% endtrans %}
                    </div>
                {% endif %}
            {% elif abstract.state.name == 'duplicate' %}
                {% trans name=abstract.submitter.name -%}
                    <strong>{{ name }}</strong> submitted this abstract but it was marked as duplicate of another.
                {%- endtrans %}
                {% if abstract.duplicate_of.can_access(session.user) %}
                    <div>
                        {% trans url=url_for('.display_abstract', abstract.duplicate_of) %}
                            <a href="{{ url }}">Go to abstract</a>
                        {% endtrans %}
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
{% endmacro %}

{% macro render_attachments(abstract, management) %}
    {% if abstract.files %}
        <div class="files field-separator">
            <table class="tree">
                {% for file in abstract.files %}
                    <tr>
                        <td>
                            <span class="{{ icon_from_mimetype(file.content_type, 'icon-file-filled') }}">
                                <a href="{{ url_for('.download_attachment', file) }}" target="_blank">
                                    {{ file.filename }}
                                </a>
                            </span>
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    {% endif %}
{% endmacro %}

{% macro _render_field_value(value) %}
        <div class="field-value {{ 'single-choice 'if value.contribution_field.field_type == 'single_choice' else ''}}">
            <label>{{ value.contribution_field.title }}</label>
            {% if value.friendly_data %}
                <span class="value">{{ value.friendly_data }}</span>
            {% else %}
                <span class="value empty">{% trans %}No answer{% endtrans %}</span>
            {% endif %}
        </div>
{% endmacro %}

{% macro _render_judgment_action(abstract) %}
    {% set action = abstract.state.name %}
    {% if action == 'withdrawn' %}
        {% trans name=abstract.submitter.name -%}
            <strong>{{ name }}</strong> withdrew this abstract
        {%- endtrans %}
    {% elif abstract.can_judge(session.user) %}
        {% if action == 'accepted' %}
            {% trans name=abstract.judge.name -%}
                <strong>{{ name }}</strong> accepted this abstract
            {%- endtrans %}
        {% elif action == 'rejected' %}
            {% trans name=abstract.judge.name -%}
                <strong>{{ name }}</strong> rejected this abstract
            {%- endtrans %}
        {% elif action == 'merged' %}
            {% trans name=abstract.judge.name -%}
                <strong>{{ name }}</strong> merged this abstract into another
            {%- endtrans %}
        {% elif action == 'duplicate' %}
            {% trans name=abstract.judge.name -%}
                <strong>{{ name }}</strong> marked this abstract as duplicate of another
            {%- endtrans %}
        {% endif %}
    {% else %}
        {% if action == 'accepted' %}
            {% trans %}This abstract was accepted{% endtrans %}
        {% elif action == 'rejected' %}
            {% trans %}This abstract was rejected{% endtrans %}
        {% elif action == 'merged' %}
            {% trans %}This abstract was merged{% endtrans %}
        {% elif action == 'duplicate' %}
            {% trans %}This abstract was marked as duplicate{% endtrans %}
        {% endif %}
    {% endif %}
{% endmacro %}

{% macro render_abstract_public(abstract, management=false) %}
    <div id="abstract-title">
        <h3 class="abstract-title">
            {{ abstract.title }}
            <span class="abstract-id">
                #{{ abstract.friendly_id }}
            </span>
        </h3>
        <div class="toolbar thin">
            {% set can_manage = abstract.event_new.can_manage(session.user) %}
            {% if abstract.submitter == session.user or can_manage %}
                <div class="group">
                    {% if abstract.can_withdraw(session.user, check_state=true) %}
                        <a title="{% trans %}Withdraw abstract{% endtrans %}"
                           class="i-button text-color danger icon-cross"
                           data-href="{{ url_for('.withdraw_abstract', abstract, management=management) }}"
                           data-method="POST"
                           data-update='{"display_html": ".mainContent .col2", "management_html": ".management-page"}'
                           data-title="{% trans %}Withdraw Abstract{% endtrans %}"
                           data-confirm="{% trans %}Do you really want to withdraw this abstract? This operation is irreversible.{% endtrans %}">
                            {% trans %}Withdraw{% endtrans %}
                        </a>
                    {% elif abstract.state.name == 'withdrawn' and can_manage %}
                        <a title="{% trans %}This abstract has been withdrawn but can be restored using this option{% endtrans %}"
                           data-href="{{ url_for('.reset_abstract_state', abstract, management=management) }}"
                           data-method="POST"
                           data-update='{"display_html": ".mainContent .col2", "management_html": ".management-page"}'
                           data-title="{% trans %}Restore Abstract{% endtrans %}"
                           data-confirm="{% trans %}Do you really want to restore this abstract? This operation is irreversible.{% endtrans %}"
                           class="i-button accept icon-lamp">
                            {% trans %}Restore{% endtrans %}
                        </a>
                    {% endif %}
                </div>
            {% endif %}
            {% if abstract.can_see_reviews(session.user) %}
                <div class="group">
                    <a class="i-button arrow icon-file-pdf js-dropdown-abstract-pdf" data-toggle="dropdown"></a>
                    <ul class="dropdown">
                        <li>
                            <a href="{{ url_for('.display_abstract_pdf_export', abstract) }}">PDF</a>
                        </li>
                        <li>
                            <a href="{{ url_for('.manage_abstract_pdf_export', abstract) }}">
                                {%- trans %}PDF with reviews{% endtrans -%}
                            </a>
                        </li>
                    </ul>
                </div>
                <script>
                    $('.js-dropdown-abstract-pdf').parent().dropdown();
                </script>
            {% else %}
                <div class="group">
                    <a class="i-button icon-file-pdf"
                       href="{{ url_for('.display_abstract_pdf_export', abstract) }}"
                       title="{% trans %}Download abstract submission in PDF{% endtrans %}"></a>
                </div>
            {% endif %}
            {% if can_manage or abstract.user_owns(session.user) %}
                <div class="group">
                    {% if abstract.can_edit(session.user) %}
                        <a href="#" class="i-button icon-edit"
                           title="{% trans %}Edit abstract{% endtrans %}"
                           data-href="{{ url_for('.edit_abstract', abstract, management=management) }}"
                           data-title="{% trans %}Edit abstract{% endtrans %}"
                           data-ajax-dialog
                           data-reload-after></a>
                    {% elif abstract.public_state.name == 'withdrawn' %}
                        <a class="i-button icon-edit disabled"
                           title="{% trans %}The abstract cannot be edited because it was withdrawn{% endtrans %}"></a>
                    {% elif abstract.public_state.name == 'under_review' %}
                        <a class="i-button icon-edit disabled"
                           title="{% trans %}The abstract cannot be edited because it is already under review{% endtrans %}"></a>
                    {% elif abstract.public_state.name != 'awaiting' %}
                        <a class="i-button icon-edit disabled"
                           title="{% trans %}The abstract cannot be edited because it has already been processed{% endtrans %}"></a>
                    {% else %}
                        <a class="i-button icon-edit disabled"
                           title="{% trans %}The abstract cannot be edited because the modification deadline has passed{% endtrans %}"></a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>

    <div id="abstract-public">
        {{ _render_abstract_summary(abstract, management) }}
        <div class="abstract-content js-mathjax">
            <div class="abstract-authorship-block">
                <div class="abstract-authorship-label">
                    {% trans count=abstract.primary_authors|length -%}
                        Author:
                    {%- pluralize -%}
                        Authors:
                    {%- endtrans %}
                </div>
                <div class="abstract-authorship-list">
                    {{ abstract.primary_authors|map(attribute='name')|join(', ') }}
                </div>
            </div>
            {% if abstract.secondary_authors %}
                <div class="abstract-authorship-block">
                    <div class="abstract-authorship-label">
                        {% trans count=abstract.secondary_authors|length -%}
                            Co-author:
                        {%- pluralize -%}
                            Co-authors:
                        {%- endtrans %}
                    </div>
                    <div class="abstract-authorship-list">
                        {{ abstract.secondary_authors|map(attribute='name')|join(', ') }}
                    </div>
                </div>
            {% endif %}
            {{ abstract.description }}
        </div>

        <div id="abstract-submission-details" class="i-timeline">
            <div class="i-timeline-item">
                <div class="i-timeline-item-label action"></div>
                <div class="i-timeline-item-box header-indicator">
                    <div class="i-box-header">
                        {% trans name=abstract.submitter.name -%}
                            <strong>{{ name }}</strong> submitted this abstract
                        {%- endtrans %}
                        <time datetime="{{ abstract.submitted_dt.isoformat() }}">
                            {{- abstract.submitted_dt|format_human_date -}}
                        </time>
                        {% if abstract.modified_dt %}
                            {{ render_edited_hint(abstract.modified_dt, abstract.modified_by) }}
                        {% endif %}
                    </div>
                    <div class="i-box-content submission-info">
                        {{ _render_submission_info(abstract, management) }}
                        {% if abstract.event_new.cfa.allow_attachments %}
                            <div class="attachment-list">
                                {{ render_attachments(abstract, management) }}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if abstract.state.name not in ('submitted', 'withdrawn') %}
                <div class="i-timeline-item">
                    <div class="i-timeline-item-label action"></div>
                    <div class="i-timeline-item-box header-indicator">
                        <div class="i-box-header flex">
                            <div class="stretch">
                                {{ _render_judgment_action(abstract) }}
                                <time datetime="{{ abstract.judgment_dt.isoformat() }}">
                                    {{- abstract.judgment_dt|format_human_date -}}
                                </time>
                            </div>
                            {% if abstract.event_new.can_manage(session.user) %}
                                <div>
                                    <a class="i-button-icon icon-remove"
                                       title="{% trans %}Reset judgement{% endtrans %}"
                                       data-href="{{ url_for('.reset_abstract_state', abstract, management=management) }}"
                                       data-method="POST"
                                       data-update='{"display_html": ".mainContent .col2", "management_html": ".management-page"}'
                                       data-title="{% trans %}Reset judgment{% endtrans %}"
                                       data-confirm="{% trans %}Do you really want to reset the judgment? This operation is irreversible.{% endtrans %}"></a>
                                </div>
                            {% endif %}
                        </div>
                        <div class="i-box-content">
                            {% if abstract.state.name == 'accepted' %}
                                {% if abstract.contribution %}
                                    {% set link_start = '<a href="%s">'|safe|format(url_for('contributions.display_contribution', abstract.contribution)) %}
                                    {% set link_end = '</a>'|safe %}
                                {% else %}
                                    {% set link_start = '' %}
                                    {% set link_end = '' %}
                                {% endif %}
                                {% if abstract.accepted_contrib_type and abstract.accepted_track %}
                                    {% trans type=abstract.accepted_contrib_type.name, track=abstract.accepted_track.title -%}
                                        The abstract was accepted
                                        as <span class="abstract-contribution-type">{{ type }}</span>
                                        for track <span class="abstract-track">{{ track }}</span>
                                        and a {{ link_start }}contribution{{ link_end }} was created in the event.
                                    {%- endtrans %}
                                {% elif abstract.accepted_contrib_type %}
                                    {% trans type=abstract.accepted_contrib_type.name -%}
                                        The abstract was accepted
                                        as <span class="abstract-contribution-type">{{ type }}</span>
                                        and a {{ link_start }}contribution{{ link_end }} was created in the event.
                                    {%- endtrans %}
                                {% elif abstract.accepted_track %}
                                    {% trans track=abstract.accepted_track.title -%}
                                        The abstract was accepted
                                        for track <span class="abstract-track">{{ track }}</span>
                                        and a {{ link_start }}contribution{{ link_end }} was created in the event.
                                    {%- endtrans %}
                                {% else %}
                                    {% trans -%}
                                        The abstract was accepted and a {{ link_start }}contribution{{ link_end }} was created in the event.
                                    {%- endtrans %}
                                {% endif %}
                            {% elif abstract.state.name == 'rejected' %}
                                {% trans %}The abstract was rejected.{% endtrans %}
                            {% elif abstract.state.name == 'merged' %}
                                {% trans url=url_for('.display_abstract', abstract.merged_into), other=abstract.merged_into.title -%}
                                    The abstract was merged into {{ link_start }}{{ other }}{{ link_end }}.
                                {%- endtrans %}
                            {% elif abstract.state.name == 'duplicate'%}
                                {% trans url=url_for('.display_abstract', abstract.duplicate_of), other=abstract.duplicate_of.title -%}
                                    The abstract was marked as a duplicate of {{ link_start }}{{ other }}{{ link_end }}
                                {%- endtrans %}
                            {% endif %}
                            {% if abstract.judgment_comment %}
                                <div class="titled-rule">
                                    {% trans %}Comment{% endtrans %}
                                </div>
                                {{ abstract.judgment_comment }}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        {% if abstract.email_logs and abstract.can_judge(session.user, check_state=false) %}
            <a class="open-abstract-notification-log"
               data-href="{{ url_for('.notification_log', abstract) }}"
               data-title="{% trans %}Sent notifications{% endtrans %}"
               data-subtitle="{% trans %}Log of notifications sent to submitter and authors of this abstract{% endtrans %}"
               data-ajax-dialog>
                {% trans count=abstract.email_logs|length -%}
                    1 notification sent
                {%- pluralize -%}
                    {{ count }} notifications sent
                {%- endtrans %}
            </a>
        {% endif %}
    </div>
{% endmacro %}
