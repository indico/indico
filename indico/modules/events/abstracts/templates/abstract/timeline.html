{% from 'events/abstracts/abstract/_common.html' import render_edited_hint, render_score, render_visibility_hint %}
{% from 'events/abstracts/abstract/review.html' import render_comment_form, render_review_form %}


{% macro render_timeline(abstract, comment_form, review_form=none) %}
    {% set can_comment = abstract.can_comment(session.user) %}
    {% set can_review = abstract.can_review(session.user, check_state=true) %}
    {% if abstract.comments or can_comment or can_review %}
        <div id="abstract-timeline" class="i-timeline with-line">
            <div class="i-timeline-connect-up"></div>
            {% for item in abstract.get_timeline(session.user) %}
                {% if item.TIMELINE_TYPE == 'comment' %}
                    {{ _render_comment(item) }}
                {% elif item.TIMELINE_TYPE == 'review' %}
                    {{ _render_review(item, form=form) }}
                {% endif %}
            {% endfor %}
            {% if can_comment or can_review %}
                {{ _render_input(abstract, comment_form, review_form) }}
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}


{% macro _render_comment(comment) %}
    <div id="abstract-comment-{{ comment.id }}" class="i-timeline-item">
        <div class="i-timeline-item-label action"></div>
        <div class="i-timeline-item-box header-indicator">
            <div class="i-box-header flex">
                <div class="stretch">
                    {% trans name=comment.user.name -%}
                        <strong>{{ name }}</strong> left a comment
                    {%- endtrans %}
                    {{ render_visibility_hint(comment.visibility) }}
                    <time datetime="{{ comment.created_dt.isoformat() }}">
                        {{- comment.created_dt|format_human_date -}}
                    </time>
                    {% if comment.modified_dt %}
                        {{ render_edited_hint(comment.modified_dt, comment.modified_by) }}
                    {% endif %}
                </div>
                {% if comment.can_edit(session.user) %}
                    <div class="abstract-comment-badges">
                        <a class="i-button-icon icon-edit js-edit-comment"
                           title="{% trans %}Edit comment{% endtrans %}"
                           data-href="{{ url_for('.edit_abstract_comment', comment) }}"
                           data-form-container="#abstract-comment-{{ comment.id }} .js-form-container"
                           data-update=".management-page"
                           data-replace-update
                           data-confirm-close-unsaved
                           data-ajax-form></a>
                        <a class="i-button-icon icon-cross js-delete-comment"
                           title="{% trans %}Remove comment{% endtrans %}"
                           data-method="DELETE"
                           data-href="{{ url_for('.delete_abstract_comment', comment) }}"
                           data-title="{% trans %}Remove comment{% endtrans %}"
                           data-confirm="{% trans %}Are you sure you want to remove this comment?{% endtrans %}"
                           data-ajax>
                        </a>
                    </div>
                {% endif %}
            </div>
            <div class="i-box-content js-form-container">
                <div class="markdown-text">
                    {{ comment.text }}
                </div>
            </div>
        </div>
    </div>
{% endmacro %}


{% macro _render_review(review, form, management=false) %}
    <div id="abstract-review-{{ review.id }}" class="i-timeline-item">
        <div class="i-timeline-item-label action abstract-comment-pic"></div>
        <div class="i-timeline-item-box header-indicator">
            <div class="i-box-header flex">
                <div class="stretch">
                    {% trans name=review.user.name -%}
                        <strong>{{ name }}</strong> left a review
                    {%- endtrans %}
                    {{ render_visibility_hint(review.visibility) }}
                    <time datetime="{{ review.created_dt.isoformat() }}">
                        {{- review.created_dt|format_human_date -}}
                    </time>
                    {% if review.modified_dt %}
                        {{ render_edited_hint(review.modified_dt) }}
                    {% endif %}
                </div>
                <div class="abstract-comment-badges flex">
                    <div class="stretch">
                        <span>
                            {% trans action=_render_review_state(review) -%}
                                Proposes to {{ action }}
                            {%- endtrans %}
                        </span>
                        {% if review.score is not none %}
                            {{ render_score(review.score, review.abstract.event_new.cfa) }}
                        {% endif %}
                    </div>
                    {% if review.can_edit(session.user, check_state=true) %}
                        <div>
                            <a class="i-button-icon icon-edit js-edit-review"
                               title="{% trans %}Edit review{% endtrans %}"
                               data-href="{{ url_for('.edit_review', review, management=management) }}"
                               data-form-container="#abstract-review-{{ review.id }} .js-form-container"
                               data-update=".management-page"
                               data-replace-update
                               data-confirm-close-unsaved
                               data-ajax-form></a>
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="i-box-content js-form-container">
                {% if review.proposed_action.name == 'accept' %}
                    {% if review.proposed_contribution_type %}
                        {% set contribution_type -%}
                            <strong>{{ review.proposed_contribution_type.name|escape }}</strong>
                        {%- endset %}
                        {% trans type=contribution_type|safe -%}
                            Proposed to accept as {{ type }}
                        {%- endtrans %}
                    {% else %}
                        {% trans -%}
                            Proposed to accept
                        {%- endtrans %}
                    {% endif %}
                {% elif review.proposed_action.name == 'change_tracks' %}
                    {% set tracks -%}
                        {% for track in review.proposed_tracks -%}
                            <span class="abstract-track">{{ track.short_title|escape }}</span>
                            {%- if not loop.last -%}, {% endif -%}
                        {% endfor %}
                    {%- endset %}
                    {% trans count=review.proposed_tracks|length, tracks=tracks|safe -%}
                        Possible destination track: {{ tracks }}
                    {%- pluralize -%}
                        Possible destination tracks: {{ tracks }}
                    {%- endtrans %}
                {% elif review.proposed_action.name in ('mark_as_duplicate', 'merge') %}
                    {% set other_abstract = review.proposed_related_abstract %}
                    {% set abstract_link -%}
                        <a href="{{ url_for('.display_abstract', other_abstract) }}">
                            {{ other_abstract.title|escape }}
                        </a>
                    {%- endset %}
                    {% if review.proposed_action.name == 'merge' %}
                        {% trans title=abstract_link|safe -%}
                            Proposed to be merged into {{ title }}
                        {%- endtrans %}
                    {% elif review.proposed_action.name == 'mark_as_duplicate' %}
                        {% trans title=abstract_link|safe -%}
                            Proposed as duplicate of {{ title }}
                        {%- endtrans %}
                    {% endif %}
                {% endif %}
                {% if review.ratings %}
                    <div class="titled-rule">
                        {% trans %}Ratings{% endtrans %}
                    </div>
                    <ul class="abstract-question-list">
                    {% for rating in review.ratings|sort(attribute='question.position') %}
                        <li class="flex">
                            <div>
                                <span class="question-index">{{ loop.index }}</span>
                            </div>
                            <div class="question-text stretch">
                                {{ rating.question.text }}
                            </div>
                            <div>
                                <span class="value">
                                    {{ _render_rating(review.abstract.event_new.cfa, rating.value) }}
                                    <span class="number">{{ rating.value }}</span>
                                </span>
                            </div>
                        </li>
                    {% endfor %}
                    </ul>
                {% endif %}
                {% if review.comment %}
                    <div class="titled-rule">
                        {% trans %}Comment{% endtrans %}
                    </div>
                    <div class="markdown-text">
                        {{ review.comment }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endmacro %}


{% macro _render_rating(cfa, value) %}
    {%- for bullet in range(cfa.rating_range[0], cfa.rating_range[1] + 1) -%}
        <span class="bullet {{ 'full' if bullet <= value else '' }}"></span>
    {%- endfor -%}
{% endmacro %}


{% macro _render_review_state(review) %}
    {% set mapping = {'accept': 'success',
                      'reject': 'error',
                      'merge': 'visited',
                      'mark_as_duplicate': 'strong',
                      'change_tracks': 'warning'} %}
    <span class="i-tag outline {{ mapping[review.proposed_action.name] }}">
        {{ review.proposed_action.title -}}
    </span>
{% endmacro %}


{% macro _render_input(abstract, comment_form, review_form=none) %}
    <div id="abstract-timeline-input" class="i-timeline-item">
        <div class="i-timeline-item-label action"></div>
        <div class="i-timeline-item-box footer-only header-indicator">
            <div class="i-box-footer js-form-container">
                <div class="flex">
                    {% if abstract.can_comment(session.user) %}
                        <div class="stretch">
                            {{ render_comment_form(comment_form, abstract) }}
                        </div>
                        {% if abstract.can_review(session.user, check_state=true) %}
                            {{ _render_review_trigger(abstract) }}
                        {% endif %}
                    {% elif abstract.can_review(session.user, check_state=true) %}
                        {{ _render_input_no_comment(abstract, review_form) }}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endmacro %}


{% macro _render_input_no_comment(abstract, review_form=none) %}
    {% set reviewer_data = abstract.get_reviewer_render_data(session.user) %}
    {% if reviewer_data.tracks|length == 1 and not reviewer_data.reviews %}
        {{ render_review_form(review_form, abstract, reviewer_data.tracks|first, on_pageload=true) }}
    {% else %}
        {% set missing_tracks = reviewer_data.missing_tracks|length %}
        {% if missing_tracks %}
            {% if not reviewer_data.reviews %}
                {% set no_comments_title %}
                    {%- trans count=missing_tracks -%}
                        You can review this abstract in one track
                    {%- pluralize -%}
                        You can review this abstract in {{ missing_tracks }} tracks
                    {%- endtrans -%}
                {% endset %}
            {% else %}
                {% set no_comments_title %}
                    {%- trans count=missing_tracks -%}
                        You can review this abstract in one more track
                    {%- pluralize -%}
                        You can review this abstract in {{ missing_tracks }} more tracks
                    {%- endtrans -%}
                {% endset %}
            {% endif %}
            {% set no_comments_description %}
                {%- trans %}You can do it until a final judgment is casted{% endtrans -%}
            {% endset %}
        {% else %}
            {% set no_comments_title %}
                {%- trans %}You have already reviewed this abstract in all your tracks{% endtrans -%}
            {% endset %}
            {% set no_comments_description %}
                {%- trans %}You can still make up your mind{% endtrans -%}
            {% endset %}
        {% endif %}
        <div class="stretch">
            <div class="empty-input-title">
                {{- no_comments_title -}}
            </div>
            <div class="empty-input-description">
                {{- no_comments_description -}}
            </div>
        </div>
        {{ _render_review_trigger(abstract, exclusive=true) }}
    {% endif %}
{% endmacro %}


{% macro _render_review_trigger(abstract, exclusive=false) %}
    {% set reviewer_data = abstract.get_reviewer_render_data(session.user) %}
    <div class="review-trigger flex">
        {% if not exclusive %}
            <span class="comment-or-review">
                {%- trans %}or{% endtrans -%}
            </span>
        {% endif %}
        {% if reviewer_data.tracks|length == 1 %}
            {% set track = reviewer_data.tracks|first %}
            {% if track in reviewer_data.reviewed_tracks %}
                {% set review = reviewer_data.reviews[track] %}
                <button class="i-button big highlight text-color js-new-edit-review" data-review-id="{{ review.id }}">
                    {%- trans %}Change review{% endtrans -%}
                </button>
            {% else %}
                <button class="i-button big highlight text-color"
                        data-href="{{ url_for('.review_abstract', abstract, track) }}"
                        data-form-container="#abstract-timeline-input .js-form-container"
                        data-update=".management-page"
                        data-replace-update
                        data-confirm-close-unsaved
                        data-ajax-form>
                    {%- trans %}Review{% endtrans -%}
                </button>
            {% endif %}
        {% else %}
            <button class="i-button big highlight text-color arrow js-dropdown" data-toggle="dropdown">
                {% if reviewer_data.tracks.issubset(reviewer_data.reviewed_tracks) %}
                    {%- trans %}Change reviews{% endtrans -%}
                {% else %}
                    {%- trans %}Review{% endtrans -%}
                {% endif %}
            </button>
            <ul class="dropdown">
                {% for track in reviewer_data.tracks|sort(attribute='title') %}
                    <li>
                        {% if track in reviewer_data.reviewed_tracks %}
                            {% set review = reviewer_data.reviews[track] %}
                            <a class="js-new-edit-review" data-review-id="{{ review.id }}">
                                {{ track.full_title }}
                                <i class="icon-circle-small" title="{% trans %}Already reviewed{% endtrans %}"></i>
                            </a>
                        {% else %}
                            <a data-href="{{ url_for('.review_abstract', abstract, track) }}"
                               data-form-container="#abstract-timeline-input .js-form-container"
                               data-update=".management-page"
                               data-replace-update
                               data-confirm-close-unsaved
                               data-ajax-form>
                                {{ track.full_title }}
                            </a>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>
{% endmacro %}
