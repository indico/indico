{% extends 'events/surveys/manage_survey_base.html' %}

{% block subtitle %}
    {% trans title=survey.title %}Results for "{{ title }}"{% endtrans %}
{% endblock %}

{% block content %}
    <div id="survey-results" class="i-box-group vert">
        {% for question in survey.questions %}
            <div class="i-box titled">
                <div class="i-box-header">
                    <div class="i-box-title">
                        {{ loop.index }}. {{ question.title }}
                    </div>
                    <div class="i-box-metadata">
                        <span class="label">{% trans %}Answered:{% endtrans %}</span>
                        <span class="content">{{ question.not_empty_answers|count }}</span>
                    </div>
                </div>
                <div class="i-box-content">
                    {% if question.field_type == 'text' %}
                        {{ text_answer(question) }}
                    {% elif question.field_type == 'number' %}
                        {{ number_answer(question) }}
                    {% elif question.field_type in ('bool', 'single_choice') %}
                        {{ single_choice_answer(question) }}
                    {% elif question.field_type == 'multiselect' %}
                        {{ multiple_choice_answer(question) }}
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}


{% macro text_answer(question) %}
    {% for answer in question.get_summary() %}
        <div class="text-answer">{{ answer }}</div>
    {% endfor %}
{% endmacro %}


{% macro number_answer(question) %}
    {% set summary = question.get_summary() %}
    {% if summary %}
        <div class="chart-answer">
            <div class="chart-option-details">
                <strong>{% trans %}Average:{% endtrans %}</strong> {{ '%0.2f'|format(summary.average) }}
            </div>
            <div class="chart-option-details">
                <strong>{% trans %}Min:{% endtrans %}</strong> {{ summary.min }}
            </div>
            <div class="chart-option-details">
                <strong>{% trans %}Max:{% endtrans %}</strong> {{ summary.max }}
            </div>
            <div class="chart-option-details">
                <strong>{% trans %}Total:{% endtrans %}</strong> {{ summary.total }}
            </div>
        </div>
        {{ _chart('bar', summary) }}
    {% endif %}
{% endmacro %}


{% macro single_choice_answer(question) %}
    {{ _choice_answer(question, 'pie') }}
{% endmacro %}


{% macro multiple_choice_answer(question) %}
    {{ _choice_answer(question, 'bar') }}
{% endmacro %}


{% macro _choice_answer(question, chart_type) %}
    {% set summary = question.get_summary() %}
    <div class="chart-answer">
        {% for label, value in summary.relative.iteritems() %}
            <div class="chart-option-details">
                <strong>{{ label }}</strong>: {{ summary.absolute[label] }} ({{ '%0.2f'|format(value * 100) }}%)
            </div>
        {% endfor %}
    </div>
    {{ _chart(chart_type, summary) }}
{% endmacro %}


{% macro _chart(chart_type, summary) %}
    <div class="chart-answer">
        <div class="survey-{{ chart_type }}-chart"
            data-labels="{{ summary.absolute.keys()|tojson|forceescape }}"
            data-series-absolute="{{ summary.absolute.values() }}"
            data-series-relative="{{ summary.relative.values() }}"></div>
    </div>
{% endmacro %}
