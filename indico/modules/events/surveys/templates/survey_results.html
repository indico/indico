{% extends 'events/surveys/manage_survey_base.html' %}

{% block subtitle %}
    {% trans title=survey.title %}Results for "{{ title }}"{% endtrans %}
{% endblock %}

{% block content %}
    <div id="survey-results" class="i-box-group vert">
        {% for question in survey.questions %}
            <div class="i-box titled">
                <div class="i-box-header">
                    <div class="i-box-title">
                        {{ loop.index }}. {{ question.title }}
                    </div>
                    <div class="i-box-metadata">
                        <span class="label">{% trans %}Answered:{% endtrans %}</span>
                        <span class="content">{{ question.not_empty_answers|count }}</span>
                    </div>
                </div>
                <div class="i-box-content">
                    {% if question.field_type == 'text' %}
                        {{ text_answer(question) }}
                    {% elif question.field_type == 'number' %}
                        {{ number_answer(question) }}
                    {% elif question.field_type in ('bool', 'single_choice') %}
                        {{ single_choice_answer(question) }}
                    {% elif question.field_type == 'multiselect' %}
                        {{ multiple_choice_answer(question) }}
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}


{% macro text_answer(question) %}
    {% for answer in question.get_summary() %}
        <div class="text-answer">{{ answer }}</div>
    {% endfor %}
{% endmacro %}


{% macro number_answer(question) %}
    {% set summary = question.get_summary() %}
    {% if summary %}
        <div class="number-answer">
            <div class="i-badge">
                <div class="i-badge-content">
                    <div class="i-badge-value">
                        {{ summary.min }}
                    </div>
                    <span class="i-badge-title">
                        {% trans %}Min{% endtrans %}
                    </span>
                </div>
            </div>
            <div class="i-badge">
                <div class="i-badge-content">
                    <div class="i-badge-value">
                        {{ '%0.2f'|format(summary.average) }}
                    </div>
                    <span class="i-badge-title">
                        {% trans %}Average{% endtrans %}
                    </span>
                </div>
            </div>
            <div class="i-badge">
                <div class="i-badge-content">
                    <div class="i-badge-value">
                        {{ summary.max }}
                    </div>
                    <span class="i-badge-title">
                        {% trans %}Max{% endtrans %}
                    </span>
                </div>
            </div>
            <div class="i-badge">
                <div class="i-badge-content">
                    <div class="i-badge-value">
                        {{ summary.total }}
                    </div>
                    <span class="i-badge-title">
                        {% trans %}Total{% endtrans %}
                    </span>
                </div>
            </div>
        </div>
    {% endif %}
{% endmacro %}


{% macro single_choice_answer(question) %}
    {{ _choice_answer(question) }}
    {% set summary = question.get_summary() %}
    <script>
        var chart = new Chartist.Pie('#q-{{ question.id }}-chart', {
            labels: {{ summary.relative.keys()|tojson }},
            series: {{ summary.relative.values()|tojson }}
        }, {
            donut: true,
            donutWidth: 20,
            startAngle: 270,
            total: 1,
            chartPadding: 20,
            labelOffset: 20,
            labelDirection: 'explode'
        }).on('draw', function(data) {
            if (data.value === 0) {
                chart.data.labels[data.index] = ''
            }
        });
    </script>
{% endmacro %}


{% macro multiple_choice_answer(question) %}
    {{ _choice_answer(question) }}
    {% set summary = question.get_summary() %}
    <script>
        new Chartist.Bar('#q-{{ question.id }}-chart', {
            labels: {{ summary.absolute.keys()|tojson }},
            series: [{{ summary.absolute.values()|tojson }}]
        }, {
            horizontalBars: true,
            reverseData: true,
            axisX: {
                onlyInteger: true,
            },
            axisY: {
                offset: 50
            }
        });
    </script>
{% endmacro %}


{% macro _choice_answer(question) %}
    {% set summary = question.get_summary() %}
    <div class="chart-answer">
        {% for label, value in summary.relative.iteritems() %}
            <div class="chart-option-details">
                <strong>{{ label }}</strong>: {{ summary.absolute[label] }} ({{ '%0.2f'|format(value * 100) }}%)
            </div>
        {% endfor %}
    </div>
    <div class="chart-answer">
        <div id="q-{{ question.id }}-chart" class="chart"></div>
    </div>
{% endmacro %}
