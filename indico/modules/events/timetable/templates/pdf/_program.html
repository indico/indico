{% macro render_program(event, days, config) %}
    {% for day in days %}
        <div class="day pagebreak program-{{loop.index}} {{ 'pagebreak-children' if config.new_page_per_session else '' }}" id="day-{{ loop.index }}">
            <div class="day-title">
                <h2>{{ day|format_skeleton('EEEEdMMMM', timezone=event.timezone) }}</h2>
            </div>
            {% for entry in days[day] %}
                {% set should_render = (
                    entry.type.name == 'SESSION_BLOCK' or
                    (entry.type.name == 'CONTRIBUTION' and config.show_contribs) or
                    (entry.type.name == 'BREAK' and config.show_breaks)
                ) %}

                {% if should_render %}
                    <div class="day-entry">
                        {% if entry.type.name != 'CONTRIBUTION' %} 
                            {{ get_color_styles(entry) }}
                        {% endif %}
                        <div class="time-text time-from">
                            {{ entry.start_dt|format_time(timezone=event.timezone) }}
                        </div>
                        <section class="{{ get_custom_id(entry) }}">
                            {{ render_block_date(entry, day, config.print_date_close_to_sessions) }}
                            <section class="session-block {{ 'contribution' if entry.type.name == 'CONTRIBUTION' else '' }}">
                                <div class="session-block-wrapper">
                                    {% if entry.type.name == 'BREAK' %}
                                        {{ render_break(entry) }}
                                    {% elif entry.type.name == 'CONTRIBUTION' %}
                                        {{ render_contrib(entry, config) }}
                                    {% else %}
                                        {{
                                            render_session_block(
                                                entry,
                                                config
                                            )
                                        }}
                                    {% endif %}
                                </div>
                            </section>
                        </section>
                        <div class="time-text time-to">
                            {{ entry.end_dt|format_time(timezone=event.timezone) }}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    {% endfor %}
{% endmacro %}

{% macro render_break(entry) %}
    {% set break = entry.object %}

    <section
        id="entry-{{ entry.id }}"
        class="session-block-title inherited-bg-color inherited-txt-color"
    >
        {{ render_entry_header(entry) }}
    </section>
{% endmacro %}

{% macro render_contrib(entry, config) %}
    {% set contrib = entry.object %}
    {% set speakers = contrib.speakers %}
    {% set subcontribs = contrib.subcontributions %}
    {% set show_contrib_content = subcontribs or (config.show_abstract and contrib.description) %}

    <section
        id="entry-{{ entry.id }}"
        class="session-block-title inherited-bg-color inherited-txt-color {{ 'only-round-top' if show_contrib_content else ''}}"
    >
        {{ render_entry_header(entry) }}
    </section>
    {% if show_contrib_content %}
        <div class="session-block-content">
            {{ render_description(contrib.description) }}
            {% if subcontribs %}
                {{ render_subcontribs(contrib, config) }}
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}

{% macro render_session_block(entry, config) %}
    {% set session_block = entry.object %}
    {% set sess = session_block.session %}
    {% set conveners = session_block.person_links %}
    {% set contributions = session_block.contributions %}
    {% set show_session_block_content = entry.children or (config.show_session_description and sess.description) %}

    <section
        id="entry-{{ entry.id }}"
        class="session-block-title inherited-bg-color inherited-txt-color {{ 'only-round-top' if show_session_block_content else ''}}"
    >
        {{ render_entry_header(entry) }}
    </section>
    {% if show_session_block_content %}
        <div class="session-block-content">
            {% if config.show_session_description and sess.description %}
                {{ render_description(sess.description) }}
            {% endif %}
            {% if entry.children %}
                {{ render_block_child_entries(sess, entry.children, config) }}
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}

{% macro render_block_child_entries(sess, children, config) %}
    <div class="session-block-content-box inherited-border-color">
        <ul class="contrib-timeline">
            {% for child in children %}
                <li class="inherited-border-color">
                    <div class="contrib-heading">
                        {% if not sess.is_poster %}
                            <span class="timebox inherited-bg-color inherited-txt-color">
                                {{ format_interval(child.start_dt.astimezone(child.event.tzinfo), child.end_dt.astimezone(child.event.tzinfo), format='HHmm') }}
                                {% if config.show_length_contribs %}
                                    ({{ (child.end_dt - child.start_dt)|format_human_timedelta(narrow=True) }})
                                {% endif %}
                            </span>
                        {% endif %}
                        <h4>{{ child.object.title }}</h4>
                    </div>
                    {% if child.type.name == 'CONTRIBUTION' %}
                        <div class="contrib-timeline-content" >
                            {{ render_child_contrib(child.object, config) }}
                        </div>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    </div>
{% endmacro %}

{% macro render_child_contrib(contrib, config) %}
    {% set speakers = contrib.speakers %}

    {% if speakers %}
        <p>
            <span class="bold">{{ ngettext('Speaker', 'Speakers', speakers|length) }}</span><br />
            {{ render_names(speakers, show_title=config.show_title, show_affiliation=config.show_affiliation) }}
        </p>
    {% endif %}

    {% if not contrib.inherit_location and contrib.has_location_info %}
        <p>
            <span class="bold">{% trans %}Location{% endtrans %}</span><br />
            {{ render_place(contrib) }}
        </p>
    {% endif %}
    {% if config.show_abstract and (not config.dont_show_poster_abstract or contrib.session.is_poster) and contrib.description %}
        <div class="description">
            <span class="bold">{% trans %}Description{% endtrans %}</span>
            <div>{{ contrib.description }}</div>
        </div>
    {% endif %}
    {% if contrib.subcontributions %}
        {{ render_subcontribs(contrib, config) }}
    {% endif %}
{% endmacro %}

{% macro render_subcontribs(contrib, config) %}
    {% set subcontribs %}
        {% for subcontrib in contrib.subcontributions %}
            <li class="inherited-border-color">
                <div class="contrib-heading">
                    {% if config.show_length_contribs and (not contrib.session or not contrib.session.is_poster) %}
                        <span class="timebox inherited-bg-color inherited-txt-color">
                            {{ (subcontrib.duration)|format_human_timedelta(narrow=True) }}
                        </span>
                    {% endif %}
                    <h4>{{ subcontrib.title }}</h4>
                </div>
                <div class="contrib-timeline-content">
                    {{ render_subcontrib(subcontrib, config) }}
                </div>
            </li>
        {% endfor%}
    {% endset %}

    {% if contrib.session %}
        <div>
            <span class="bold">{% trans %}Subcontributions{% endtrans %}</span>
            <ul class="sub-contrib-timeline inherited-bg-color-trans inherited-border-color">
                {{ subcontribs }}
            </ul>
        </div>
    {% else %}
        <div class="session-block-content-box inherited-border-color">
            <ul class="contrib-timeline">
                {{ subcontribs }}
            </ul>
        </div>
    {% endif %}
{% endmacro %}

{% macro render_subcontrib(subcontrib, config) %}
    {{ render_child_contrib(subcontrib, config) }}
{% endmacro %}

{% macro render_entry_header(entry) %}
    {% set object = entry.object %}
    {% set sess = object.session %}
    {% set type = entry.type.name %}

    <h3>
        {% if type == 'SESSION_BLOCK' %}
            {{ render_block_title(object) }}
        {% else %}
            {{ object.title }}
        {% endif %}
    </h3>
    <div class="session-block-title-info">
        <p>
            <span class="bold">
                {% if type == 'BREAK' %}
                    {% trans %}Break{% endtrans %}
                {% elif type == 'CONTRIBUTION' %}
                    {% trans %}Contribution{% endtrans %}
                {% elif sess.is_poster %}
                    {% trans %}Poster Session{% endtrans %}
                {% else %}
                    {% trans %}Session{% endtrans %}
                {% endif %}
            </span>
        </p>
        <p>
            <span class="bold">{% trans %}Location{% endtrans %}:</span>
            {{ render_place(entry) }}
        </p>
        {% if type != 'BREAK' %}
            {% set people = object.person_links if type == 'SESSION_BLOCK' else object.speakers %}
            <span class="bold">
                {% if type == 'SESSION_BLOCK' %}
                    {{ ngettext('Convener:', 'Conveners:', people|length) }}
                {% else %}
                    {{ ngettext('Speaker:', 'Speakers:', people|length) }}
                {% endif %}
            </span>
            {{ render_names(people, show_title=config.show_title, show_affiliation=config.show_affiliation) }}
        {% endif %}
    </div>
{% endmacro %}

{% macro render_block_date(entry, day, print_date_close_to_sessions) %}
    {% if print_date_close_to_sessions %}
        <p class="session-block-date">
            <span class="bold">{{ day|format_skeleton('EEEEdMMMM', timezone=entry.event.timezone) }}</span>
            <span class="timebox">
                {{ format_interval(entry.start_dt.astimezone(entry.event.tzinfo), entry.end_dt.astimezone(entry.event.tzinfo), format='HHmm') }}
            </span>
        </p>
    {% endif %}
{% endmacro %}

{% macro render_time(entry) %}
    <div class="time">
        <div class="time-from">
            {{ entry.start_dt|format_time(timezone=entry.event.timezone) }}
        </div>
        <div class="time-divider">
            {# Line between generated in CSS #}
        </div>
        <div class="time-divider">
            {# Line between generated in CSS #}
        </div>
        <div class="time-to">
            {{ entry.end_dt|format_time(timezone=entry.event.timezone) }}
        </div>
    </div>
{% endmacro %}

{# Utilities #}

{% macro render_place(entry) %}
    {% set entry = entry.object if entry.object else entry %}

    {{ [entry.venue_name, entry.room_name, entry.address] | select | join(', ') }}
{% endmacro %}

{% macro render_names(people, show_title=false, show_affiliation=false) %}
    {% for person in people %}
        {%- if show_title %}
            {{ person.title }}
        {%- endif %}
        {{ person.display_full_name }}
        {%- if show_affiliation and person.affiliation %}
            ({{ person.affiliation }})
        {%- endif -%}
        {%- if not loop.last %},{% endif %}
    {% endfor %}
{% endmacro %}

{% macro get_custom_id(entry) -%}
    {{ 'c' ~ entry.type ~ '-' ~ entry.id }}
{% endmacro %}

{% macro get_color_styles(entry) %}
    {% set c_id = get_custom_id(entry) %}
    {% set colors = entry.object.colors or entry.object.session.colors %}

    <style>
        .{{ c_id }} .inherited-bg-color {
            background-color: #{{ colors.background }};
        }

        .{{ c_id }} .inherited-bg-color-trans {
            background-color: #{{ colors.background }}66;
        }

        .{{ c_id }} .inherited-txt-color {
            color: #{{ colors.text }};
        }

        .{{ c_id }} .inherited-border-color {
            border-color: #{{ colors.background }};
        }
    </style>
{% endmacro %}


{% macro render_description(description) %}
    <div class="session-block-content-box description inherited-border-color">
        <ul class="contrib-timeline">
            <li>
                <h4>{% trans %}Description{% endtrans %}</h4>
                {{ description }}
            </li>
        </ul>
    </div>
{% endmacro %}

{% macro render_block_title(block) %}
    <h3>
        {{ block.session.title }}
        {% if block.title %}: {{ block.title }}{% endif %}
    </h3>
{% endmacro %}
