{% macro event_list(events_by_month, future_events_by_month, future_event_count, past_event_count, format_event_date, is_recent, happening_now, category_id) %}
    <div class="eventList">
        {% if future_event_count %}
            <div class="topBar" style="margin-bottom: 10px">
                <div class="content smaller">
                    <span id="futureEventsShow">
                        {% trans count=future_event_count -%}
                            There is {{ count }} event in the future.
                        {%- pluralize -%}
                            There are {{ count }} events in the future.
                        {%- endtrans %}
                        <span class="fakeLink futureEventsLink">Show them.</span>
                    </span>
                    <span id="futureEventsHide" style="display: none;">
                        {% trans count=future_event_count -%}
                            {{ count }} event in the future.
                        {%- pluralize -%}
                            {{ count }} events in the future.
                        {%- endtrans %}
                        <span class="fakeLink futureEventsLink">{% trans %}Hide{% endtrans %}</span>
                    </span>
                </div>
            </div>

            <div id="futureEvents" style="display: none;">
                {{ event_list_block(future_events_by_month, format_event_date, is_recent, happening_now) }}
            </div>
        {% endif %}
        <div>
            {{ event_list_block(events_by_month, format_event_date, is_recent, happening_now) }}
        </div>
        {% if past_event_count %}
            <div id="pastEvents"></div>
            <div class="topBar">
                <div class="content smaller">
                    <span id="pastEventsText">
                        <span id="pastEventsShow" class="pastEventsControl">
                            {% trans count=past_event_count -%}
                                There is {{ count }} event in the past.
                            {%- pluralize -%}
                                There are {{ count }} events in the past.
                            {%- endtrans %}
                            <span class="fakeLink pastEventsLink">{% trans %}Show them.{% endtrans %}</span>
                        </span>
                        <span id="pastEventsHide" class="pastEventsControl" style="display: none;">
                            {% trans count = past_event_count -%}
                                <span class="fakeLink pastEventsLink">Hide</span> past events ({{ count }}).
                            {%- endtrans %}
                        </span>
                        <span id="loadingPast" class="loadingPast"><em>{% trans %}fetching past events...{% endtrans %}</em></span>
                    </span>
                </div>
            </div>
        {% endif %}
    </div>
    <script>
        (function() {
            'use strict';

            // Future events
            $('.futureEventsLink').on('click', function() {
                var fe = $('#futureEvents');
                if (fe.is(':visible')) {
                    $('#futureEventsShow').show();
                    $('#futureEventsHide').hide();
                    fe.slideUp('medium');
                }
                else {
                    $('#futureEventsHide').show();
                    $('#futureEventsShow').hide();
                    fe.slideDown('medium');
                }
            });

            // Past events
            {% if past_event_count >0 %}
                var numOfEventsInThePast = {{ past_event_count }};
            {% endif %}

            function setShowPastEventsForCateg(show){
                indicoRequest('category.setShowPastEventsForCateg', {
                    categId: '{{ category_id }}',
                    showPastEvents: show
                }, function() { });
            }

            $('.pastEventsLink').click(function() {
                if (numOfEventsInThePast) {
                    // We need to fetch the events
                    setShowPastEventsForCateg(true);
                    fetchPastEvents();
                }
                else {
                    if ($('#pastEvents').is(':visible')) {
                        $('#pastEvents').hide();
                        $('#pastEventsHide').hide();
                        $('#pastEventsShow').show();
                        setShowPastEventsForCateg(false);
                    }
                    else {
                        $('#pastEvents').show();
                        $('#pastEventsHide').show();
                        $('#pastEventsShow').hide();
                        setShowPastEventsForCateg(true);
                    }
                }
            });

            function fetchPastEvents() {
                $('#loadingPast').show();
                $('.pastEventsControl').hide();
                indicoRequest('category.getPastEventsList', {
                    categId: '{{ category_id }}',
                    lastIdx: numOfEventsInThePast
                }, function(result, error){
                    if (result) {
                        numOfEventsInThePast -= result.num;
                        $.each(result.events, function(i, month) {
                            var id = 'eventList-' + month.year + '-' + month.month;
                            var eventListUL = $('#' + id);
                            if(!eventListUL.length) {
                                eventListUL = $('<ul/>', {id: id});
                                eventListUL.appendTo('#pastEvents').before($('<h4/>').html(month.title));
                            }
                            eventListUL.append($('<div/>').html(month.events.join('')).children());
                        });
                        if(numOfEventsInThePast > 0) {
                            fetchPastEvents();
                        }
                        else {
                            $('#loadingPast').hide();
                            $('#pastEventsHide').show();
                        }
                    }
                });
            }
            {% if show_past_events %}
                fetchPastEvents();
            {% endif %}
        })();
    </script>
{% endmacro %}

{% macro event_list_block(events_by_month, format_event_date, is_recent, happening_now) %}
    {% for month in events_by_month %}
        <h4 {% if month.is_current %}class="currentMonth"{% endif %}>
            <span>{{ month.name }}</span>
        </h4>
        <ul>
            {% for event in month.events %}
                <li itemscope itemtype="http://data-vocabulary.org/Event">
                    <span class="ical">
                        <a class="icon-calendar" href="{{ url_for('events.export_event_ical', event) }}"></a>
                    </span>
                    <span class="listName">
                        <span class="date {% if happening_now(event) %}today{% endif %}">
                            {{ format_event_date(event) }}
                            <time itemprop="startDate" datetime="{{ event.start_dt.isoformat() }}">
                        </span>
                        <a href="{{ url_for('event.conferenceDisplay', event) }}" itemprop="url">
                            <span itemprop="summary">{{ event.title }}</span>
                        </a>
                        <span class="protected">
                            {% if event.is_self_protected %}
                                <span data-type="restricted">({% trans %}protected{% endtrans %})</span>
                            {% endif %}

                            {% if is_recent(event.created_dt) %}
                                <i class="icon-new new-label" title="{% trans %}This event is new.{% endtrans %}"></i>
                            {% endif %}
                        </span>
                    </span>
                </li>
            {% endfor %}
        </ul>
    {% endfor %}
{% endmacro %}
