{% extends 'forms/base_widget.html' %}
{% from 'forms/_form.html' import form_field %}

{% block html %}
    <div class="datetime-widget i-form-field-fixed-width">
        <input type="hidden" autofocus>
        <input type="text" name="{{ field.name }}" id="{{ field.id }}-date" class="datepicker" readonly
               {% if field.data and not field.date_missing %}value="{{ field.data | format_date('code', timezone=field.timezone) }}"{% endif %}
               {% if required %}required{% endif %}
               {% if disabled %}disabled{% endif %}>{#--#}
        <input type="time" name="{{ field.name }}" id="{{ field.id }}-time" class="timepicker"
               placeholder="HH:MM" pattern="{{ time_regex_hhmm }}"
               {% if field.data and not field.time_missing %}value="{{ field.data | format_time('code', timezone=field.timezone) }}"{% endif %}
               {% if disabled %}disabled{% endif %}>{#--#}
        <i class="timezone"></i>{#--#}
        {% if field.allow_clear -%}
            <span id="{{ field.id }}-reset"
                  class="icon-close clear-pickers" style="display: none;"
                  title="{% trans %}Clear date and time{% endtrans %}"></span>
        {%- endif %}
    </div>
{% endblock %}

{% block javascript %}
    <script>
        (function() {
            'use strict';

            var dateField = $('#{{ field.id }}-date');
            var timeField = $('#{{ field.id }}-time');
            var resetFieldAction = $('#{{ field.id }}-reset');
            var timezoneElement = timeField.next('.timezone');
            var timezone = {{ field.timezone | tojson }};
            var initialDate;
            var initialTime;

            function clearDate() {
                dateField.datepicker('setDate', null).trigger('change');
            }

            function initTime() {
                if (timeField.val() === '') {
                    timeField.val({{ field.default_time | format_time('code', timezone=field.timezone) | tojson }});
                }
            }

            function updateDateRequired(e) {
                dateField.prop('required', e.target.value !== '');
            }

            function updateTimeRequired(e) {
                timeField.prop('required', e.target.value !== '');
            }

            function updateResetFieldAction() {
                var isVisible = !!(dateField.val() || timeField.val());
                resetFieldAction.toggle(isVisible);
            }

            timezoneElement.qtip({
                content: {
                    text: function() {
                        return timezone;
                    }
                }
            });

            {% if field.timezone_field %}
                $('#{{ field.timezone_field.id }}').on('change', function() {
                    timezone = $(this).val();
                });
            {% endif %}

            dateField.datepicker({
                onSelect: function applyOnSelectHandlers() {
                    var $this = $(this);
                    var handlers = $this.data('onSelectHandlers');
                    for (var i = 0; i < handlers.length; i++) {
                        handlers[i].apply(this, arguments);
                    }
                    // ensure we de-focus the field; otherwise clicking it again might
                    // not re-open the datepicker
                    $this.blur();
                }
            }).data('onSelectHandlers', [
                initTime,
                function() {
                    dateField.trigger('change');
                }
            ]).on('change', function(e) {
                updateTimeRequired(e);
                updateResetFieldAction();
            }).on('keydown', function(e) {
                e.preventDefault();
                if (e.which == K.BACKSPACE) {
                    clearDate();
                }
            });

            timeField.on('change', function applyOnChangeHandlers() {
                var handlers = $(this).data('onChangeHandlers');
                for (var i = 0; i < handlers.length; i++) {
                    handlers[i].apply(this, arguments);
                }
            }).data('onChangeHandlers', [updateDateRequired, updateResetFieldAction]);

            {% if field.data %}
                initialDate = dateField.val() || undefined;
                initialTime = timeField.val() || undefined;
                dateField.datepicker('setDate', initialDate);
                dateField.trigger('change');
                timeField.trigger('change');
            {% endif %}

            {% if field.earliest_dt or field.latest_dt %}
                function updateTimeLimits(selectedDate, limitDate, limitTime, attr) {
                    var selectedTime = timeField.val();
                    if (selectedDate !== limitDate || (selectedDate === initialDate && selectedTime === initialTime)) {
                        timeField.removeAttr(attr);
                    } else if (timeField.attr(attr) != limitTime) {
                        // Fix for Chrome ignoring next number keydown after min/max attr change.
                        // Delay gives some margin to type double digits.
                        setTimeout(function() {
                            timeField.attr(attr, limitTime);
                        }, 1000);
                    }
                }

                {% if field.earliest_dt %}
                    var minDate = {{ field.earliest_dt | format_date('code', timezone=field.timezone) | tojson }};
                    var minTime = {{ field.earliest_dt | format_time('code', timezone=field.timezone) | tojson }};
                    function updateMinTime(selectedDate) {
                        updateTimeLimits(selectedDate, minDate, minTime, 'min');
                    }
                    dateField.datepicker('option', 'minDate', minDate);
                    dateField.datepicker().data('onSelectHandlers').push(updateMinTime);
                    timeField.data('onChangeHandlers').push(function() {
                        var selectedDate = moment(dateField.datepicker('getDate'));
                        updateMinTime(selectedDate.format('DD/MM/YYYY'));
                    });
                    if (initialDate) {
                        updateMinTime(initialDate);
                    }
                {% endif %}

                {% if field.latest_dt %}
                    var maxDate = {{ field.latest_dt | format_date('code', timezone=field.timezone) | tojson }};
                    var maxTime = {{ field.latest_dt | format_time('code', timezone=field.timezone) | tojson }};
                    function updateMaxTime(selectedDate) {
                        updateTimeLimits(selectedDate, maxDate, maxTime, 'max');
                    }
                    dateField.datepicker('option', 'maxDate', maxDate);
                    dateField.datepicker().data('onSelectHandlers').push(updateMaxTime);
                    timeField.data('onChangeHandlers').push(function() {
                        var selectedDate = moment(dateField.datepicker('getDate'));
                        updateMaxTime(selectedDate.format('DD/MM/YYYY'));
                    });
                    if (initialDate) {
                        updateMaxTime(initialDate);
                    }
                {% endif %}
            {% endif %}

            {% if field.flags.linked_datetime %}
                var linkedDateField = $('#{{ field.get_form()[field.linked_field].id }}-date');
                function updateDateLimits(selectedDate) {
                    {% if field.linked_datetime_validator.not_before %}
                        dateField.datepicker('option', 'minDate', selectedDate);
                    {% endif %}
                    {% if field.linked_datetime_validator.not_after %}
                        dateField.datepicker('option', 'maxDate', selectedDate);
                    {% endif %}
                }
                linkedDateField.datepicker().data('onSelectHandlers').push(updateDateLimits);
                updateDateLimits(linkedDateField.datepicker('getDate'));
            {% endif %}

            resetFieldAction.on('click', function resetDateTime() {
                timeField.val('').trigger('change');
                clearDate();
            });
        })();
    </script>
{% endblock %}
