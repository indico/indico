{% extends 'forms/base_widget.html' %}

{% block html %}
    {% set value_json = field._value() | tojson %}
    <div class="form-row" data-tooltip-anchor>
        <div id="userGroupList-{{ field.id }}" style="margin-bottom: 10px;"></div>
        <input type="hidden" id="{{ field.id }}" name="{{ field.name }}" value="{{ value_json | forceescape }}">
        <span></span>
    </div>
{% endblock %}

{% block javascript %}
    <script>
        (function() {
            var field = $('#{{ field.id }}');
            var principals = JSON.parse(field.val());

            function addPrincipal(newPrincipals, setResult) {
                // remove existing ones first to avoid duplicates
                _.each(newPrincipals, function(principal) {
                    principals = _.without(principals, _.findWhere(principals, {
                        identifier: principal.identifier
                    }));
                });
                principals = principals.concat(newPrincipals);
                field.val(JSON.stringify(principals));
                field.trigger('change');
                setResult(true);
            }
            function removePrincipal(principal, setResult) {
                principals = _.without(principals, _.findWhere(principals, {
                    identifier: principal.get('identifier')
                }));
                field.val(JSON.stringify(principals));
                field.trigger('change');
                setResult(true);
            }
            var widget = new UserListField(
                'PluginOptionPeopleListDiv', 'PeopleList', principals,
                true, null, true,
                {{ field.groups | tojson }},
                null, null, false, false, false, true,
                addPrincipal, userListNothing, removePrincipal, {{ field.allow_external|tojson }}
            );

            $E('userGroupList-{{ field.id }}').set(widget.draw());
        })();
    </script>
{% endblock %}
