{% extends 'forms/base_widget.html' %}


{% block html %}
    <div class="i-form-field-fixed-width" data-tooltip-anchor>
        <div id="category-title-{{ field.id }}" class="text-holder-box"></div>
        <a class="i-button" id="categorynav-button-{{ field.id }}"
           data-title='{% trans %}Choose category{% endtrans %}'>
            {%- trans %}Choose category{% endtrans -%}
        </a>
        <input type="hidden" id="{{ field.id }}" name="{{ field.name }}" value="{{ field._value() | tojson | forceescape }}">
    </div>
{% endblock %}


{% block javascript %}
    <script>
        (function() {
            'use strict';

            var $field = $('#{{ field.id }}');
            var $categoryTitle = $('#category-title-{{ field.id }}');
            var $dialogTrigger = $('#categorynav-button-{{ field.id }}');
            var hiddenData = $field.val() ? JSON.parse($field.val()) : {};

            if (hiddenData) {
                $categoryTitle.text(hiddenData.title);
                $field.val(JSON.stringify(hiddenData));
            }

            $dialogTrigger.on('click', function(evt) {
                evt.preventDefault();
                $('<div>').categorynavigator({
                    openInDialog: true,
                    selectLeafOnly: {{ field.select_leaf_only | tojson }},
                    onAction: function(category) {
                        var evt = $.Event('indico:categorySelected');
                        var dfd = $.Deferred();
                        $categoryTitle.text(category.title);
                        hiddenData = {id: category.id, title: category.title};
                        $field.val(JSON.stringify(hiddenData)).trigger(evt, [category, dfd]);
                        if (evt.isDefaultPrevented()) {
                            return dfd;
                        }
                    }
                });
            });
        })();
    </script>
{% endblock %}
