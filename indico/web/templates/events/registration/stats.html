{% from '_statistics.html' import stats_badges, stats_box, stats_table %}

{% macro stats_overview(data) %}
    {% set height = data.countries|length * 24 + 28 %}
    {% set badges = [(_("Registrants"),  data.registrants|length),
                     (_("Days left<br>to register"), data.days_left),
                     (_("Countries"), data.num_countries)]%}
    {% set taken, total, progress = data.availability %}

    {% call stats_box(title=data.title, subtitle=data.headline,
                      label=data.currency if data.show_currency_info else '') %}
        {{ stats_badges(badges) }}
        {%- if total > 0 -%}
            <div class="stats-item">
                <span>{% trans %}Availability{% endtrans %}</span>
                <span>
                    <span class="i-progress">
                        <span class="i-progress-bar" data-progress={{ '{:%}'.format(progress) }}></span>
                        <span class="i-progress-label">
                            {%- if total == taken %}
                                {%- trans %}event full{% endtrans -%}
                            {%- else -%}
                                {%- trans places=total-taken %}{{ places }} places available{% endtrans -%}
                            {% endif -%}
                        </span>
                    </span>
                </span>
            </div>
        {% endif %}
        {% if data.num_countries %}
            <div class="stats-item">
                <span>{% trans %}Registrants per country{% endtrans %}</span><span></span>
            </div>
            <div id="countriesPlot" style="width:500px; height:{{height}}px;"></div>
            <script>
                $(document).ready(function generateBasicStats() {
                    var countries = {{ data.countries|tojson }};
                    var countriesPlot = $.jqplot('countriesPlot', [countries], {
                        animate: !$.jqplot.use_excanvas,
                        animateReplot: !$.jqplot.use_excanvas,
                        grid: { shadow: false },
                        height: {{ height }},
                        seriesDefaults: {
                            renderer: $.jqplot.BarRenderer,
                            rendererOptions: {
                                animation: { speed: 1000 },
                                barDirection: 'horizontal',
                                barWidth: 18,
                                shadow: true,
                                shadowOffset: 1,
                                shadowDepth: 3,
                                highlightColors: '#0085B9'
                            },
                            pointLabels: {
                                show: true,
                                location: 'w',
                                xpadding: 4,
                                edgeTolerance: -2,
                                color: 'white'
                            }
                        },
                        seriesColors: ['#007CAC'],  // indico blue
                        highlighter: {
                            show: true,
                            showMarker: false,
                            showTooltip: false
                        },
                        axes: {
                            yaxis: {
                                pad: 8,
                                renderer: $.jqplot.CategoryAxisRenderer,
                                labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
                                tickRenderer: $.jqplot.CanvasAxisTickRenderer,
                                tickOptions: {
                                    showGridline: false,
                                    markSize: 0,
                                    tickSpacing: 24,
                                    showLabel: true
                                }
                            },
                            xaxis: {
                                min: 0,
                                padMax: 0,
                                tickRenderer: $.jqplot.CanvasAxisTickRenderer,
                                tickOptions: { markSize: 0 }
                            }
                        },
                        legend: { show: false }
                    });
                });
            </script>
        {% endif %}
    {% endcall %}
{% endmacro %}

<h2 class="group-title">{% trans %}Registrants Statistics{% endtrans %}</h2>
<div class="i-box-group horz vert registrant-stats">
    {%- for data in stats -%}
        {%- if data.type == 'overview' -%}
            {{ stats_overview(data) }}
        {%- elif data.type == 'table' -%}
            {% call stats_box(title=data.title, subtitle=data.headline,
                              label=data.currency if data.show_currency_info else '',
                              label_tooltip=_('Currency: {}').format(
                                  get_currency_name(data.currency, locale=session.lang))) %}
                {{ stats_table(data.get_table()) }}
            {%- endcall %}
        {%- endif -%}

    {%- endfor -%}
</div>
<script>
    $(document).on('click', 'table.registrant-stats tr.header-row', function toggleSubRows(evt) {
        $(this).nextUntil('tr.header-row, tr.single-row').toggle();
        $(this).toggleClass('collapsed');
    });
</script>
